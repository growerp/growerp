<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">

    <!-- ============================================ -->
    <!-- MARKETING PERSONA SERVICES                   -->
    <!-- ============================================ -->

    <service verb="create" noun="MarketingPersona" authenticate="true">
        <description>Create a new marketing persona.</description>
        <in-parameters>
            <parameter name="pseudoId" />
            <parameter name="name" required="true" />
            <parameter name="demographics" />
            <parameter name="painPoints" />
            <parameter name="goals" />
            <parameter name="toneOfVoice" />
        </in-parameters>
        <out-parameters>
            <parameter name="personaId" />
            <parameter name="pseudoId" />
            <parameter name="name" />
            <parameter name="demographics" />
            <parameter name="painPoints" />
            <parameter name="goals" />
            <parameter name="toneOfVoice" />
            <parameter name="createdDate" type="Timestamp" />
            <parameter name="lastModifiedDate" type="Timestamp" />
        </out-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
                out-map="context" />
            <if condition="!ownerPartyId">
                <return error="true" message="User not authenticated or no party associated" />
            </if>

            <!-- Generate pseudoId only if not provided -->
            <if condition="!pseudoId">
                <service-call name="growerp.100.GeneralServices100.getNext#PseudoId"
                    in-map="[ownerPartyId: ownerPartyId, seqName: 'marketingPersona']"
                    out-map="context" />
                <set field="pseudoId" from="seqNum" />
            </if>

            <service-call name="create#growerp.marketing.MarketingPersona" out-map="context"
                in-map="[
                    pseudoId: pseudoId,
                    ownerPartyId: ownerPartyId,
                    name: name,
                    demographics: demographics,
                    painPoints: painPoints,
                    goals: goals,
                    toneOfVoice: toneOfVoice,
                    createdDate: ec.user.nowTimestamp,
                    lastModifiedDate: ec.user.nowTimestamp
                ]" />

            <!-- Get the created persona and return its fields directly -->
            <entity-find-one entity-name="growerp.marketing.MarketingPersona" value-field="persona">
                <field-map field-name="personaId" />
            </entity-find-one>

            <set field="name" from="persona.name" />
            <set field="demographics" from="persona.demographics" />
            <set field="painPoints" from="persona.painPoints" />
            <set field="goals" from="persona.goals" />
            <set field="toneOfVoice" from="persona.toneOfVoice" />
            <set field="createdDate" from="persona.createdDate" />
            <set field="lastModifiedDate" from="persona.lastModifiedDate" />
        </actions>
    </service>

    <service verb="update" noun="MarketingPersona" authenticate="true">
        <in-parameters>
            <parameter name="personaId" required="true" />
            <parameter name="pseudoId" />
            <parameter name="name" />
            <parameter name="demographics" />
            <parameter name="painPoints" />
            <parameter name="goals" />
            <parameter name="toneOfVoice" />
        </in-parameters>
        <out-parameters>
            <parameter name="personaId" />
            <parameter name="pseudoId" />
            <parameter name="name" />
            <parameter name="demographics" />
            <parameter name="painPoints" />
            <parameter name="goals" />
            <parameter name="toneOfVoice" />
            <parameter name="createdDate" type="Timestamp" />
            <parameter name="lastModifiedDate" type="Timestamp" />
        </out-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
                out-map="context" />
            <entity-find-one entity-name="growerp.marketing.MarketingPersona" value-field="persona">
                <field-map field-name="personaId" />
                <field-map field-name="ownerPartyId" />
            </entity-find-one>
            <if condition="!persona">
                <return error="true" message="Persona not found or access denied" />
            </if>

            <!-- Generate pseudoId only if not provided -->
            <if condition="!pseudoId">
                <service-call name="growerp.100.GeneralServices100.getNext#PseudoId"
                    in-map="[ownerPartyId: ownerPartyId, seqName: 'marketingPersona']"
                    out-map="context" />
                <set field="pseudoId" from="seqNum" />
            </if>

            <service-call name="update#growerp.marketing.MarketingPersona"
                in-map="context + [lastModifiedDate: ec.user.nowTimestamp]" />

            <!-- Get the updated persona and return its fields directly -->
            <entity-find-one entity-name="growerp.marketing.MarketingPersona" value-field="persona">
                <field-map field-name="personaId" />
            </entity-find-one>

            <set field="pseudoId" from="persona.pseudoId" />
            <set field="name" from="persona.name" />
            <set field="demographics" from="persona.demographics" />
            <set field="painPoints" from="persona.painPoints" />
            <set field="goals" from="persona.goals" />
            <set field="toneOfVoice" from="persona.toneOfVoice" />
            <set field="createdDate" from="persona.createdDate" />
            <set field="lastModifiedDate" from="persona.lastModifiedDate" />
        </actions>
    </service>

    <service verb="delete" noun="MarketingPersona" authenticate="true">
        <in-parameters>
            <parameter name="personaId" required="true" />
        </in-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
                out-map="context" />
            <entity-find-one entity-name="growerp.marketing.MarketingPersona" value-field="persona">
                <field-map field-name="personaId" />
                <field-map field-name="ownerPartyId" />
            </entity-find-one>
            <if condition="!persona">
                <return error="true" message="Persona not found or access denied" />
            </if>

            <service-call name="delete#growerp.marketing.MarketingPersona"
                in-map="[personaId: personaId]" />
        </actions>
    </service>

    <service verb="list" noun="MarketingPersonas" authenticate="true">
        <in-parameters>
            <parameter name="searchString" />
            <parameter name="start" type="Integer" />
            <parameter name="limit" type="Integer" />
        </in-parameters>
        <out-parameters>
            <parameter name="personas" type="List" />
        </out-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
                out-map="context" />
            <entity-find entity-name="growerp.marketing.MarketingPersona" list="personas"
                offset="start" limit="limit">
                <search-form-inputs default-order-by="-lastModifiedDate" />
                <econdition field-name="ownerPartyId" />
                <econditions combine="or">
                    <econdition field-name="pseudoId" operator="like" value="%${searchString}%"
                        ignore-if-empty="true" ignore-case="true" />
                    <econdition field-name="name" operator="like" value="%${searchString}%"
                        ignore-if-empty="true" ignore-case="true" />
                </econditions>
                <select-field
                    field-name="personaId,pseudoId,name,demographics,painPoints,goals,toneOfVoice" />
                <order-by field-name="-lastModifiedDate" />
            </entity-find>
        </actions>
    </service>

    <!-- ============================================ -->
    <!-- AI GENERATION SERVICES                       -->
    <!-- ============================================ -->

    <service verb="generate" noun="MarketingPersona" authenticate="true">
        <description>Generate a persona using AI based on business description.</description>
        <in-parameters>
            <parameter name="businessDescription" required="true" />
            <parameter name="targetMarket" />
        </in-parameters>
        <out-parameters>
            <parameter name="personaId" />
            <parameter name="pseudoId" />
            <parameter name="name" />
            <parameter name="demographics" />
            <parameter name="painPoints" />
            <parameter name="goals" />
            <parameter name="toneOfVoice" />
        </out-parameters>
        <actions>
            <script location="component://growerp/service/generatePersonaWithAI.groovy" />
        </actions>
    </service>

    <!-- ============================================ -->
    <!-- CONTENT PLAN SERVICES                        -->
    <!-- ============================================ -->

    <service verb="create" noun="ContentPlan" authenticate="true">
        <description>Create a new content plan.</description>
        <in-parameters>
            <parameter name="pseudoId" />
            <parameter name="personaId" />
            <parameter name="weekStartDate" type="Long" />
            <parameter name="theme" />
        </in-parameters>
        <out-parameters>
            <parameter name="planId" />
            <parameter name="pseudoId" />
            <parameter name="personaId" />
            <parameter name="weekStartDate" type="Timestamp" />
            <parameter name="theme" />
            <parameter name="createdDate" type="Timestamp" />
            <parameter name="lastModifiedDate" type="Timestamp" />
        </out-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
                out-map="context" />
            <if condition="!ownerPartyId">
                <return error="true" message="User not authenticated or no party associated" />
            </if>

            <!-- Generate pseudoId only if not provided -->
            <if condition="!pseudoId">
                <service-call name="growerp.100.GeneralServices100.getNext#PseudoId"
                    in-map="[ownerPartyId: ownerPartyId, seqName: 'contentPlan']"
                    out-map="context" />
                <set field="pseudoId" from="seqNum" />
            </if>

            <!-- Convert milliseconds to Timestamp -->
            <if condition="weekStartDate">
                <set field="weekStartDate" from="new java.sql.Timestamp(weekStartDate)" />
            </if>

            <service-call name="create#growerp.marketing.ContentPlan" out-map="context"
                in-map="[
                    pseudoId: pseudoId,
                    ownerPartyId: ownerPartyId,
                    personaId: personaId,
                    weekStartDate: weekStartDate,
                    theme: theme,
                    createdDate: ec.user.nowTimestamp,
                    lastModifiedDate: ec.user.nowTimestamp
                ]" />

            <!-- Get the created plan and return its fields directly -->
            <entity-find-one entity-name="growerp.marketing.ContentPlan" value-field="plan">
                <field-map field-name="planId" />
            </entity-find-one>

            <set field="personaId" from="plan.personaId" />
            <set field="weekStartDate" from="plan.weekStartDate" />
            <set field="theme" from="plan.theme" />
            <set field="createdDate" from="plan.createdDate" />
            <set field="lastModifiedDate" from="plan.lastModifiedDate" />
        </actions>
    </service>

    <service verb="update" noun="ContentPlan" authenticate="true">
        <in-parameters>
            <parameter name="planId" required="true" />
            <parameter name="pseudoId" />
            <parameter name="personaId" />
            <parameter name="weekStartDate" type="Long" />
            <parameter name="theme" />
        </in-parameters>
        <out-parameters>
            <parameter name="planId" />
            <parameter name="pseudoId" />
            <parameter name="personaId" />
            <parameter name="weekStartDate" type="Timestamp" />
            <parameter name="theme" />
            <parameter name="createdDate" type="Timestamp" />
            <parameter name="lastModifiedDate" type="Timestamp" />
        </out-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
                out-map="context" />
            <entity-find-one entity-name="growerp.marketing.ContentPlan" value-field="plan">
                <field-map field-name="planId" />
                <field-map field-name="ownerPartyId" />
            </entity-find-one>
            <if condition="!plan">
                <return error="true" message="Content plan not found or access denied" />
            </if>

            <!-- Convert milliseconds to Timestamp -->
            <if condition="weekStartDate">
                <set field="weekStartDate" from="new java.sql.Timestamp(weekStartDate)" />
            </if>

            <service-call name="update#growerp.marketing.ContentPlan"
                in-map="context + [lastModifiedDate: ec.user.nowTimestamp]" />

            <!-- Get the updated plan and return its fields directly -->
            <entity-find-one entity-name="growerp.marketing.ContentPlan" value-field="plan">
                <field-map field-name="planId" />
            </entity-find-one>

            <set field="pseudoId" from="plan.pseudoId" />
            <set field="personaId" from="plan.personaId" />
            <set field="weekStartDate" from="plan.weekStartDate" />
            <set field="theme" from="plan.theme" />
            <set field="createdDate" from="plan.createdDate" />
            <set field="lastModifiedDate" from="plan.lastModifiedDate" />
        </actions>
    </service>

    <service verb="delete" noun="ContentPlan" authenticate="true">
        <in-parameters>
            <parameter name="planId" required="true" />
        </in-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
                out-map="context" />
            <entity-find-one entity-name="growerp.marketing.ContentPlan" value-field="plan">
                <field-map field-name="planId" />
                <field-map field-name="ownerPartyId" />
            </entity-find-one>
            <if condition="!plan">
                <return error="true" message="Content plan not found or access denied" />
            </if>

            <!-- Delete associated social posts first -->
            <entity-delete-by-condition entity-name="growerp.marketing.SocialPost">
                <econdition field-name="planId" />
            </entity-delete-by-condition>

            <service-call name="delete#growerp.marketing.ContentPlan"
                in-map="[planId: planId]" />
        </actions>
    </service>

    <service verb="list" noun="ContentPlans" authenticate="true">
        <in-parameters>
            <parameter name="searchString" />
            <parameter name="start" type="Integer" />
            <parameter name="limit" type="Integer" />
        </in-parameters>
        <out-parameters>
            <parameter name="contentPlans" type="List" />
        </out-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
                out-map="context" />
            <entity-find entity-name="growerp.marketing.ContentPlan" list="contentPlans"
                offset="start" limit="limit">
                <search-form-inputs default-order-by="-lastModifiedDate" />
                <econdition field-name="ownerPartyId" />
                <econditions combine="or">
                    <econdition field-name="pseudoId" operator="like" value="%${searchString}%"
                        ignore-if-empty="true" ignore-case="true" />
                    <econdition field-name="theme" operator="like" value="%${searchString}%"
                        ignore-if-empty="true" ignore-case="true" />
                </econditions>
                <select-field
                    field-name="planId,pseudoId,personaId,weekStartDate,theme,createdDate,lastModifiedDate" />
                <order-by field-name="-lastModifiedDate" />
            </entity-find>
        </actions>
    </service>

    <!-- ============================================ -->
    <!-- CONTENT PLAN AI GENERATION                   -->
    <!-- ============================================ -->

    <service verb="generate" noun="ContentPlan" authenticate="true">
        <description>Generate a weekly content plan (PNP) for a persona.</description>
        <in-parameters>
            <parameter name="personaId" required="true" />
            <parameter name="weekStartDate" type="Date" />
        </in-parameters>
        <out-parameters>
            <parameter name="planId" />
            <parameter name="pseudoId" />
            <parameter name="theme" />
            <parameter name="weekStartDate" />
            <parameter name="posts" type="List" />
        </out-parameters>
        <actions>
            <script location="component://growerp/service/generateContentPlanWithAI.groovy" />
        </actions>
    </service>

    <!-- ============================================ -->
    <!-- SOCIAL POST CRUD SERVICES                    -->
    <!-- ============================================ -->

    <service verb="list" noun="SocialPosts" authenticate="true">
        <in-parameters>
            <parameter name="searchString" />
            <parameter name="postId" />
            <parameter name="pseudoId" />
            <parameter name="planId" />
            <parameter name="start" type="Integer" />
            <parameter name="limit" type="Integer" />
        </in-parameters>
        <out-parameters>
            <parameter name="socialPosts" type="List" />
        </out-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
                out-map="context" />

            <if condition="searchString">
                <set field="searchString" value="%$searchString%" />
            </if>

            <entity-find entity-name="growerp.marketing.SocialPost" list="socialPosts"
                offset="start" limit="limit">
                <econdition field-name="ownerPartyId" />
                <econdition field-name="planId" from="planId" ignore-if-empty="true" />
                <econditions combine="or">
                    <econdition field-name="pseudoId" operator="like" value="%${searchString}%"
                        ignore-if-empty="true" ignore-case="true" />
                    <econdition field-name="headline" operator="like" value="%${searchString}%"
                        ignore-if-empty="true" ignore-case="true" />
                    <econdition field-name="type" operator="like" value="%${searchString}%"
                        ignore-if-empty="true" ignore-case="true" />
                </econditions>
                <order-by field-name="-lastModifiedDate" />
            </entity-find>
        </actions>
    </service>

    <service verb="create" noun="SocialPost" authenticate="true">
        <description>Create a new social post.</description>
        <in-parameters>
            <parameter name="pseudoId" />
            <parameter name="planId" />
            <parameter name="type" default-value="PAIN" />
            <parameter name="platform" />
            <parameter name="headline" />
            <parameter name="draftContent" />
            <parameter name="finalContent" />
            <parameter name="status" default-value="DRAFT" />
            <parameter name="scheduledDate" type="Long" />
        </in-parameters>
        <out-parameters>
            <parameter name="postId" />
            <parameter name="pseudoId" />
            <parameter name="planId" />
            <parameter name="type" />
            <parameter name="platform" />
            <parameter name="headline" />
            <parameter name="draftContent" />
            <parameter name="finalContent" />
            <parameter name="status" />
            <parameter name="scheduledDate" type="Timestamp" />
            <parameter name="createdDate" type="Timestamp" />
            <parameter name="lastModifiedDate" type="Timestamp" />
        </out-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
                out-map="context" />
            <if condition="!ownerPartyId">
                <return error="true" message="User not authenticated or no party associated" />
            </if>

            <!-- Generate pseudoId only if not provided -->
            <if condition="!pseudoId">
                <service-call name="growerp.100.GeneralServices100.getNext#PseudoId"
                    in-map="[ownerPartyId: ownerPartyId, seqName: 'socialPost']"
                    out-map="context" />
                <set field="pseudoId" from="seqNum" />
            </if>

            <!-- Convert scheduledDate from Long to Timestamp if provided -->
            <set field="scheduledDateTs"
                from="scheduledDate ? new java.sql.Timestamp(scheduledDate) : null" />

            <service-call name="create#growerp.marketing.SocialPost" out-map="context"
                in-map="[
                    ownerPartyId: ownerPartyId,
                    pseudoId: pseudoId,
                    planId: planId,
                    type: type,
                    platform: platform,
                    headline: headline,
                    draftContent: draftContent,
                    finalContent: finalContent,
                    status: status,
                    scheduledDate: scheduledDateTs,
                    createdDate: ec.user.nowTimestamp,
                    lastModifiedDate: ec.user.nowTimestamp
                ]" />

            <!-- Get the created post and return its fields directly -->
            <entity-find-one entity-name="growerp.marketing.SocialPost" value-field="post">
                <field-map field-name="postId" />
            </entity-find-one>

            <set field="planId" from="post.planId" />
            <set field="type" from="post.type" />
            <set field="platform" from="post.platform" />
            <set field="headline" from="post.headline" />
            <set field="draftContent" from="post.draftContent" />
            <set field="finalContent" from="post.finalContent" />
            <set field="status" from="post.status" />
            <set field="scheduledDate" from="post.scheduledDate" />
            <set field="createdDate" from="post.createdDate" />
            <set field="lastModifiedDate" from="post.lastModifiedDate" />
        </actions>
    </service>

    <service verb="update" noun="SocialPost" authenticate="true">
        <in-parameters>
            <parameter name="postId" required="true" />
            <parameter name="pseudoId" />
            <parameter name="planId" />
            <parameter name="type" />
            <parameter name="platform" />
            <parameter name="headline" />
            <parameter name="draftContent" />
            <parameter name="finalContent" />
            <parameter name="status" />
            <parameter name="scheduledDate" type="Long" />
        </in-parameters>
        <out-parameters>
            <parameter name="postId" />
            <parameter name="pseudoId" />
            <parameter name="planId" />
            <parameter name="type" />
            <parameter name="platform" />
            <parameter name="headline" />
            <parameter name="draftContent" />
            <parameter name="finalContent" />
            <parameter name="status" />
            <parameter name="scheduledDate" type="Timestamp" />
            <parameter name="createdDate" type="Timestamp" />
            <parameter name="lastModifiedDate" type="Timestamp" />
        </out-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
                out-map="context" />

            <!-- Get existing post to verify ownership -->
            <entity-find-one entity-name="growerp.marketing.SocialPost" value-field="post">
                <field-map field-name="postId" />
            </entity-find-one>
            <if condition="!post">
                <return error="true" message="Social post not found" />
            </if>

            <!-- Verify ownership via content plan if planId exists -->
            <if condition="post.planId">
                <entity-find-one entity-name="growerp.marketing.ContentPlan" value-field="plan">
                    <field-map field-name="planId" from="post.planId" />
                </entity-find-one>
                <if condition="plan &amp;&amp; plan.ownerPartyId != ownerPartyId">
                    <return error="true" message="Access denied to this social post" />
                </if>
            </if>

            <!-- Convert scheduledDate from Long to Timestamp if provided -->
            <set field="scheduledDateTs"
                from="scheduledDate ? new java.sql.Timestamp(scheduledDate) : post.scheduledDate" />

            <service-call name="update#growerp.marketing.SocialPost"
                in-map="[
                    postId: postId,
                    pseudoId: pseudoId ?: post.pseudoId,
                    planId: planId ?: post.planId,
                    type: type ?: post.type,
                    platform: platform ?: post.platform,
                    headline: headline ?: post.headline,
                    draftContent: draftContent ?: post.draftContent,
                    finalContent: finalContent ?: post.finalContent,
                    status: status ?: post.status,
                    scheduledDate: scheduledDateTs,
                    lastModifiedDate: ec.user.nowTimestamp
                ]" />

            <!-- Return updated post -->
            <entity-find-one entity-name="growerp.marketing.SocialPost" value-field="updatedPost">
                <field-map field-name="postId" />
            </entity-find-one>

            <set field="pseudoId" from="updatedPost.pseudoId" />
            <set field="planId" from="updatedPost.planId" />
            <set field="type" from="updatedPost.type" />
            <set field="platform" from="updatedPost.platform" />
            <set field="headline" from="updatedPost.headline" />
            <set field="draftContent" from="updatedPost.draftContent" />
            <set field="finalContent" from="updatedPost.finalContent" />
            <set field="status" from="updatedPost.status" />
            <set field="scheduledDate" from="updatedPost.scheduledDate" />
            <set field="createdDate" from="updatedPost.createdDate" />
            <set field="lastModifiedDate" from="updatedPost.lastModifiedDate" />
        </actions>
    </service>

    <service verb="delete" noun="SocialPost" authenticate="true">
        <in-parameters>
            <parameter name="postId" required="true" />
        </in-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
                out-map="context" />

            <entity-find-one entity-name="growerp.marketing.SocialPost" value-field="post">
                <field-map field-name="postId" />
            </entity-find-one>
            <if condition="!post">
                <return error="true" message="Social post not found" />
            </if>

            <!-- Verify ownership via content plan if planId exists -->
            <if condition="post.planId">
                <entity-find-one entity-name="growerp.marketing.ContentPlan" value-field="plan">
                    <field-map field-name="planId" from="post.planId" />
                </entity-find-one>
                <if condition="plan &amp;&amp; plan.ownerPartyId != ownerPartyId">
                    <return error="true" message="Access denied to this social post" />
                </if>
            </if>

            <service-call name="delete#growerp.marketing.SocialPost"
                in-map="[postId: postId]" />
        </actions>
    </service>

    <service verb="draft" noun="SocialPost" authenticate="true">
        <description>Draft a full social post using AI.</description>
        <in-parameters>
            <parameter name="postId" required="true" />
        </in-parameters>
        <out-parameters>
            <parameter name="content" />
            <parameter name="hashtags" type="List" />
        </out-parameters>
        <actions>
            <script location="component://growerp/service/draftSocialPostWithAI.groovy" />
        </actions>
    </service>

</services>