<?xml version="1.0" encoding="UTF-8"?>
<!--
Landing Page Services for GrowERP Landing Page System
Service definitions for landing page, sections, credibility, and CTA management
- Supports dual-ID lookup: pageId (system-wide) or pseudoId (tenant-unique)
- All services enforce multi-tenant isolation via ownerPartyId
- Implementation: Groovy service classes and REST controllers
-->
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">

  <!-- ============================================ -->
  <!-- LANDING PAGE SERVICES (6 services) -->
  <!-- ============================================ -->

  <!-- getLandingPage: Retrieve single landing page -->
  <service verb="get" noun="LandingPage" authenticate="anonymous-view">
    <description>Get landing page by ID (system-wide) or pseudoId (tenant-unique). Public access for display.</description>
    <in-parameters>
      <parameter name="landingPageId">
        <description>landing page Id</description>
      </parameter>
      <parameter name="pseudoId">
        <description>landing page pseudoId</description>
      </parameter>
      <parameter name="ownerPartyId">
        <description>Optional owner party ID required when providing pseudoId</description>
      </parameter>
    </in-parameters>
    <out-parameters>
      <parameter name="landingPage" type="Map">
        <description>Landing page object with all fields, sections, credibility</description>
        <parameter name="landingPageId" />
        <parameter name="pseudoId" />
        <parameter name="title" />
        <parameter name="headline" />
        <parameter name="description" />
        <parameter name="status" />
        <parameter name="ctaActionType" />
        <parameter name="ctaAssessmentId" />
        <parameter name="ctaButtonLink" />
        <parameter name="createdDate" type="Timestamp" />
        <parameter name="lastModifiedDate" type="Timestamp" />
        <parameter name="sections" type="List">
          <description>List of page sections</description>
          <parameter name="pageSectionId" />
          <parameter name="sectionTitle" />
          <parameter name="sectionSequence" type="Integer" />
          <parameter name="sectionText" />
        </parameter>
        <parameter name="credibility" type="Map">
          <description>Credibility/bio section</description>
          <parameter name="credibilityInfoId" />
          <parameter name="creatorBio" />
          <parameter name="backgroundText" />
          <parameter name="creatorImageUrl" />
        </parameter>
      </parameter>
    </out-parameters>
    <actions>
      <log
        message="======1111===Getting landing page for landingPageId: ${landingPageId}, pseudo: $pseudoId,ownerPartyId: ${ownerPartyId}" />
      <if condition="!ownerPartyId &amp;&amp; pseudoId">
        <service-call
          name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
          out-map="context" />
      </if>

      <if condition="!ownerPartyId">
        <return error="true" message="Unable to resolve owner party for landing page request" />
      </if>
      <!-- Query for landing page by ID (preferring pseudoId for tenant lookups) -->
      <log
        message="Looking for landingPageId: $landingPageId, pseudoId: $pseudoId and owner: $ownerPartyId" />
      <entity-find entity-name="growerp.landing.LandingPage" list="pageList">
        <!-- Use pseudoId if provided (tenant-unique), otherwise use system-wide landingPageId -->
        <econdition field-name="pseudoId" from="pseudoId" ignore-if-empty="true" />
        <econdition field-name="landingPageId" from="landingPageId" ignore-if-empty="true" />
        <econdition field-name="ownerPartyId" from="ownerPartyId" ignore-if-empty="true" />
      </entity-find>

      <if condition="!pageList">
        <return error="true"
          message="Landing page not found: pseudoId=$pseudoId, landingPageId=$landingPageId, ownerPartyId=$ownerPartyId" />
      </if>

      <set field="page" from="pageList[0]" />

      <!-- Get sections for this page -->
      <entity-find entity-name="growerp.landing.PageSection" list="sections">
        <econdition field-name="landingPageId" from="page.landingPageId" />
        <order-by field-name="sectionSequence" />
      </entity-find>
      <log level="info"
        message="Found ${sections?.size() ?: 0} sections for page ${page.landingPageId}" />
      <iterate list="sections" entry="section">
        <log level="info"
          message="  - Section: ${section.sectionTitle} (${section.pageSectionId}, seq=${section.sectionSequence})" />
      </iterate>

      <!-- Get credibility info -->
      <entity-find entity-name="growerp.landing.CredibilityInfo" list="credibilityList">
        <econdition field-name="landingPageId" from="page.landingPageId" />
      </entity-find>
      <set field="credibility" from="credibilityList ? credibilityList[0] : [:]" />

      <!-- Build unified landingPage response with page data + nested dependents -->
      <script>
        Map pageMap = page.getMap()
        pageMap.put('sections', sections ?: [])
        pageMap.put('credibility', credibility ?: [:])
        context.landingPage = pageMap
      </script>
    </actions>
  </service>

  <!-- listLandingPages: Get all landing pages for tenant -->
  <service verb="list" noun="LandingPages" authenticate="true">
    <description>List all landing pages for tenant with pagination and optional filtering. Results automatically filtered by authenticated user's company.</description>
    <in-parameters>
      <parameter name="landingPageId" />
      <parameter name="pseudoId" />
      <parameter name="status">
        <description>Optional status filter: ACTIVE, INACTIVE, DRAFT</description>
      </parameter>
      <parameter name="start" type="Integer" default-value="0">
        <description>Starting index (0-based)</description>
      </parameter>
      <parameter name="limit" type="Integer" default-value="20">
        <description>Results per page</description>
      </parameter>
      <parameter name="search">
        <description>Optional search string for title/headline</description>
      </parameter>
    </in-parameters>
    <out-parameters>
      <parameter name="landingPages" type="List">
        <description>List of landing page objects</description>
        <parameter name="landingPageId" />
        <parameter name="pseudoId" />
        <parameter name="title" />
        <parameter name="hookType" />
        <parameter name="headline" />
        <parameter name="subheading" />
        <parameter name="privacyPolicyUrl" />
        <parameter name="status" />
        <parameter name="createdDate" type="Timestamp" />
        <parameter name="lastUpdated" type="Timestamp" />
      </parameter>
      <parameter name="totalResults" type="Integer">
        <description>Total number of landing pages matching filter</description>
      </parameter>
      <parameter name="start" type="Integer">
        <description>Starting index for pagination</description>
      </parameter>
      <parameter name="limit" type="Integer">
        <description>Results per page limit</description>
      </parameter>
    </out-parameters>
    <actions>
      <!-- Get owner party ID from authenticated user context -->
      <service-call out-map="context"
        name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" />

      <if condition="search">
        <set field="search" value="%$search%" />
      </if>

      <!-- Build entity find for landing pages -->
      <entity-find entity-name="growerp.landing.LandingPage" list="pagesList" offset="start" limit="limit">
        <econdition field-name="ownerPartyId" from="ownerPartyId" />
        <econdition field-name="status" from="status" ignore-if-empty="true" />
        <econdition field-name="title" operator="like" from="search" ignore-if-empty="true" />
        <econdition field-name="landingPageId" ignore-if-empty="true" />
        <econdition field-name="pseudoId" ignore-if-empty="true" />
        <econdition field-name="search" ignore-if-empty="true" />
        <order-by field-name="-lastModifiedDate" />
      </entity-find>

      <!-- Get total count for pagination -->
      <entity-find-count entity-name="growerp.landing.LandingPage" count-field="totalResults">
        <econdition field-name="ownerPartyId" from="ownerPartyId" />
        <econdition field-name="status" from="status" ignore-if-empty="true" />
        <econdition field-name="title" operator="like" from="search" ignore-if-empty="true" />
      </entity-find-count>

      <!-- Convert entity values to maps -->
      <set field="landingPages" from="[]" />
      <iterate list="pagesList" entry="page">
        <set field="pageMap"
          from="[
          landingPageId: page.landingPageId,
          pseudoId: page.pseudoId,
          title: page.title,
          hookType: page.hookType,
          headline: page.headline,
          subheading: page.subheading,
          privacyPolicyUrl: page.privacyPolicyUrl,
          status: page.status,
          createdDate: page.createdDate,
          lastUpdated: page.lastModifiedDate
        ]" />
        <script>landingPages.add(pageMap)</script>
      </iterate>

      <log level="info"
        message="Listed ${landingPages.size()} landing pages for owner: ${ownerPartyId}" />
    </actions>
  </service>

  <!-- createLandingPage: Create new landing page -->
  <service verb="create" noun="LandingPage" authenticate="true">
    <description>Create new landing page within a tenant</description>
    <in-parameters>
      <parameter name="title" type="String" required="true">
        <description>Landing page title</description>
      </parameter>
      <parameter name="hookType">
        <description>Hook type: frustration, results, custom</description>
      </parameter>
      <parameter name="headline">
        <description>Main headline for hero section</description>
      </parameter>
      <parameter name="subheading">
        <description>Optional subheading</description>
      </parameter>
      <parameter name="privacyPolicyUrl">
        <description>Optional privacy policy link</description>
      </parameter>
      <parameter name="ctaActionType">
        <description>CTA action type: assessment or url</description>
      </parameter>
      <parameter name="ctaAssessmentId">
        <description>Assessment ID for CTA (when actionType is assessment)</description>
      </parameter>
      <parameter name="ctaButtonLink">
        <description>Button URL for CTA (when actionType is url)</description>
      </parameter>
      <parameter name="status" type="String" default-value="DRAFT">
        <description>Status: ACTIVE, INACTIVE, DRAFT</description>
      </parameter>
    </in-parameters>
    <out-parameters>
      <parameter name="landingPageId">
        <description>Created landing page system-wide unique ID</description>
      </parameter>
      <parameter name="pseudoId">
        <description>Created landing page tenant-unique ID (user-facing)</description>
      </parameter>
    </out-parameters>
    <actions>
      <!-- Get owner party ID from authenticated user context -->
      <service-call out-map="context"
        name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" />

      <!-- Generate unique pseudoId within the tenant -->
      <service-call name="growerp.100.GeneralServices100.getNext#PseudoId"
        in-map="[ownerPartyId: ownerPartyId, seqName: 'landingPage']" out-map="context" />
      <set field="pseudoId" from="seqNum" />

      <!-- Create landing page record -->
      <service-call name="create#LandingPage"
        in-map="[
        pseudoId: pseudoId,
        ownerPartyId: ownerPartyId,
        title: title,
        hookType: hookType ?: 'custom',
        headline: headline ?: title,
        subheading: subheading,
        privacyPolicyUrl: privacyPolicyUrl,
        ctaActionType: ctaActionType,
        ctaAssessmentId: ctaAssessmentId,
        ctaButtonLink: ctaButtonLink,
        status: status,
        createdDate: ec.user.nowTimestamp,
        lastModifiedDate: ec.user.nowTimestamp
      ]" />

      <log level="info"
        message="Created landing page: ${landingPageId} (${pseudoId}) for owner: ${ownerPartyId}" />
    </actions>
  </service>

  <!-- updateLandingPage: Update existing landing page -->
  <service verb="update" noun="LandingPage" authenticate="true">
    <description>Update landing page (title, hook, headline, subheading, assessment, CTA fields, status)</description>
    <in-parameters>
      <parameter name="landingPageId" type="String" required="true">
        <description>Landing page ID to update</description>
      </parameter>
      <parameter name="title">
        <description>New landing page title</description>
      </parameter>
      <parameter name="hookType">
        <description>New hook type: frustration, results, custom</description>
      </parameter>
      <parameter name="headline">
        <description>New main headline</description>
      </parameter>
      <parameter name="subheading">
        <description>New subheading</description>
      </parameter>
      <parameter name="privacyPolicyUrl">
        <description>New privacy policy URL</description>
      </parameter>
      <parameter name="ctaActionType">
        <description>CTA action type: assessment or url</description>
      </parameter>
      <parameter name="ctaAssessmentId">
        <description>Assessment ID for CTA (when actionType is assessment)</description>
      </parameter>
      <parameter name="ctaButtonLink">
        <description>Button URL for CTA (when actionType is url)</description>
      </parameter>
      <parameter name="status">
        <description>New status: ACTIVE, INACTIVE, DRAFT</description>
      </parameter>
    </in-parameters>
    <out-parameters>
      <parameter name="landingPageId">
        <description>Updated landing page ID</description>
      </parameter>
    </out-parameters>
    <actions>
      <!-- Get owner party ID from authenticated user context -->
      <service-call out-map="context"
        name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" />

      <!-- Verify landing page exists and belongs to owner -->
      <entity-find-one entity-name="LandingPage" value-field="existingPage">
        <field-map field-name="landingPageId" from="landingPageId" />
        <field-map field-name="ownerPartyId" from="ownerPartyId" />
      </entity-find-one>

      <if condition="!existingPage">
        <return error="true" message="Landing page not found or access denied" />
      </if>

      <!-- Update landing page with provided fields -->
      <service-call name="update#LandingPage"
        in-map="[
        landingPageId: landingPageId,
        title: title ?: existingPage.title,
        hookType: hookType ?: existingPage.hookType,
        headline: headline ?: existingPage.headline,
        subheading: subheading,
        privacyPolicyUrl: privacyPolicyUrl,
        ctaActionType: ctaActionType,
        ctaAssessmentId: ctaAssessmentId,
        ctaButtonLink: ctaButtonLink,
        status: status ?: existingPage.status,
        lastModifiedDate: ec.user.nowTimestamp
      ]" />

      <log level="info" message="Updated landing page: ${landingPageId} for owner: ${ownerPartyId}" />
    </actions>
  </service>

  <!-- deleteLandingPage: Delete landing page and cascade -->
  <service verb="delete" noun="LandingPage" authenticate="true">
    <description>Delete landing page and all related sections, credibility, and statistics. Owner party ID is automatically determined from authenticated user context.</description>
    <in-parameters>
      <parameter name="landingPageId" type="String" required="true">
        <description>Landing page ID to delete</description>
      </parameter>
    </in-parameters>
    <out-parameters>
      <parameter name="deletedCount" type="Integer">
        <description>Total number of records deleted (cascade)</description>
      </parameter>
    </out-parameters>
    <actions>
      <!-- Get owner party ID from authenticated user context -->
      <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
        out-map="context" />

      <!-- Verify landing page exists and belongs to owner -->
      <entity-find-one entity-name="LandingPage" value-field="existingPage">
        <field-map field-name="landingPageId" from="landingPageId" />
        <field-map field-name="ownerPartyId" from="ownerPartyId" />
      </entity-find-one>

      <if condition="!existingPage">
        <return error="true" message="Landing page not found or access denied" />
      </if>

      <set field="deletedCount" value="0" type="Integer" />

      <!-- Delete related records in cascade order -->
      <!-- 1. Delete credibility statistics -->
      <entity-find entity-name="CredibilityStatistic" list="statsToDelete">
        <econdition field-name="landingPageId" from="landingPageId" />
      </entity-find>
      <iterate list="statsToDelete" entry="stat">
        <service-call name="delete#CredibilityStatistic"
          in-map="[credibilityStatisticId: stat.credibilityStatisticId]" />
        <set field="deletedCount" from="deletedCount + 1" />
      </iterate>

      <!-- 2. Delete credibility info -->
      <entity-find entity-name="CredibilityInfo" list="credibilityToDelete">
        <econdition field-name="landingPageId" from="landingPageId" />
      </entity-find>
      <iterate list="credibilityToDelete" entry="credibility">
        <service-call name="delete#CredibilityInfo"
          in-map="[credibilityInfoId: credibility.credibilityInfoId]" />
        <set field="deletedCount" from="deletedCount + 1" />
      </iterate>

      <!-- 3. Delete page sections -->
      <entity-find entity-name="PageSection" list="sectionsToDelete">
        <econdition field-name="landingPageId" from="landingPageId" />
      </entity-find>
      <iterate list="sectionsToDelete" entry="section">
        <service-call name="delete#PageSection" in-map="[pageSectionId: section.pageSectionId]" />
        <set field="deletedCount" from="deletedCount + 1" />
      </iterate>

      <!-- 4. Finally delete the landing page itself -->
      <service-call name="delete#LandingPage" in-map="[landingPageId: landingPageId]" />
      <set field="deletedCount" from="deletedCount + 1" />

      <log level="info"
        message="Deleted landing page: ${landingPageId} and ${deletedCount} related records for owner: ${ownerPartyId}" />
    </actions>
  </service>

  <!-- publishLandingPage: Publish page to make it publicly accessible -->
  <service verb="publish" noun="LandingPage" authenticate="true">
    <description>Publish landing page to make it publicly accessible via pseudoId URL. Owner party ID is automatically determined from authenticated user context.</description>
    <in-parameters>
      <parameter name="landingPageId" type="String" required="true">
        <description>Landing page ID to publish</description>
      </parameter>
    </in-parameters>
    <out-parameters>
      <parameter name="landingPageId">
        <description>Published landing page ID</description>
      </parameter>
      <parameter name="pseudoId">
        <description>Public URL pseudoId for this page</description>
      </parameter>
      <parameter name="publicUrl">
        <description>Full public URL where page is accessible</description>
      </parameter>
    </out-parameters>
    <actions>
      <!-- Get owner party ID from authenticated user context -->
      <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
        out-map="context" />

      <!-- Verify landing page exists and belongs to owner -->
      <entity-find-one entity-name="LandingPage" value-field="landingPage">
        <field-map field-name="landingPageId" from="landingPageId" />
        <field-map field-name="ownerPartyId" from="ownerPartyId" />
      </entity-find-one>

      <if condition="!landingPage">
        <return error="true" message="Landing page not found or access denied" />
      </if>

      <!-- Update status to ACTIVE (published) -->
      <service-call name="update#LandingPage"
        in-map="[
        landingPageId: landingPageId,
        status: 'ACTIVE',
        lastModifiedDate: ec.user.nowTimestamp
      ]" />

      <!-- Set output parameters -->
      <set field="pseudoId" from="landingPage.pseudoId" />
      <set field="publicUrl" from="'https://app.growerp.com/landing/' + pseudoId" />

      <log level="info"
        message="Published landing page: ${landingPageId} (${pseudoId}) for owner: ${ownerPartyId}" />
    </actions>
  </service>

  <!-- ============================================ -->
  <!-- PAGE SECTION SERVICES (4 services) -->
  <!-- ============================================ -->

  <!-- createPageSection: Add section to landing page -->
  <service verb="create" noun="PageSection" authenticate="true">
    <description>Create new section on landing page. Owner party ID is automatically determined from authenticated user context.</description>
    <in-parameters>
      <parameter name="landingPageId" type="String" required="true">
        <description>Landing page ID</description>
      </parameter>
      <parameter name="sectionTitle" type="String" required="true">
        <description>Section title</description>
      </parameter>
      <parameter name="sectionDescription">
        <description>Section content/description</description>
      </parameter>
      <parameter name="sectionImageUrl">
        <description>Optional section image URL</description>
      </parameter>
      <parameter name="sectionSequence" type="Integer">
        <description>Display order (auto-incremented if not provided)</description>
      </parameter>
    </in-parameters>
    <out-parameters>
      <parameter name="pageSectionId">
        <description>Created section ID</description>
      </parameter>
      <parameter name="pseudoId">
        <description>Created section pseudoId</description>
      </parameter>
    </out-parameters>
    <actions>
      <!-- Get owner party ID from authenticated user context -->
      <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
        out-map="context" />

      <!-- Verify landing page exists and belongs to owner -->
      <entity-find-one entity-name="LandingPage" value-field="landingPage">
        <field-map field-name="landingPageId" from="landingPageId" />
        <field-map field-name="ownerPartyId" from="ownerPartyId" />
      </entity-find-one>

      <if condition="!landingPage">
        <return error="true" message="Landing page not found or access denied" />
      </if>

      <!-- Auto-increment sequence if not provided -->
      <if condition="!sectionSequence">
        <entity-find-count entity-name="PageSection" count-field="sectionCount">
          <econdition field-name="landingPageId" from="landingPageId" />
        </entity-find-count>
        <set field="sectionSequence" from="sectionCount + 1" />
      </if>

      <!-- Generate unique IDs -->
      <set field="pageSectionId" from="ec.entity.sequencedIdPrimary('PageSection', null, null)" />
      <set field="pseudoId" from="'section_' + System.currentTimeMillis()" />

      <!-- Create page section record -->
      <service-call name="create#PageSection"
        in-map="[
        pageSectionId: pageSectionId,
        pseudoId: pseudoId,
        landingPageId: landingPageId,
        sectionTitle: sectionTitle,
        sectionDescription: sectionDescription,
        sectionImageUrl: sectionImageUrl,
        sectionSequence: sectionSequence,
        createdDate: ec.user.nowTimestamp
      ]" />

      <log level="info" message="Created page section: ${pageSectionId} for page: ${landingPageId}" />
    </actions>
  </service>

  <!-- updatePageSection: Update section content -->
  <service verb="update" noun="PageSection" authenticate="true">
    <description>Update page section content and display order. Owner party ID is automatically determined from authenticated user context.</description>
    <in-parameters>
      <parameter name="pageSectionId" type="String" required="true">
        <description>Section ID to update</description>
      </parameter>
      <parameter name="sectionTitle">
        <description>New section title</description>
      </parameter>
      <parameter name="sectionDescription">
        <description>New section content</description>
      </parameter>
      <parameter name="sectionImageUrl">
        <description>New section image URL</description>
      </parameter>
      <parameter name="sectionSequence" type="Integer">
        <description>New display order</description>
      </parameter>
    </in-parameters>
    <out-parameters>
      <parameter name="pageSectionId">
        <description>Updated section ID</description>
      </parameter>
    </out-parameters>
    <actions>
      <!-- Get owner party ID from authenticated user context -->
      <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
        out-map="context" />

      <!-- Verify section exists and belongs to owner's landing page -->
      <entity-find-one entity-name="PageSection" value-field="existingSection">
        <field-map field-name="pageSectionId" from="pageSectionId" />
      </entity-find-one>

      <if condition="!existingSection">
        <return error="true" message="Page section not found" />
      </if>

      <!-- Verify the section's landing page belongs to owner -->
      <entity-find-one entity-name="LandingPage" value-field="landingPage">
        <field-map field-name="landingPageId" from="existingSection.landingPageId" />
        <field-map field-name="ownerPartyId" from="ownerPartyId" />
      </entity-find-one>

      <if condition="!landingPage">
        <return error="true" message="Access denied to this page section" />
      </if>

      <!-- Update section with provided fields -->
      <service-call name="update#PageSection"
        in-map="[
        pageSectionId: pageSectionId,
        sectionTitle: sectionTitle ?: existingSection.sectionTitle,
        sectionDescription: sectionDescription,
        sectionImageUrl: sectionImageUrl,
        sectionSequence: sectionSequence ?: existingSection.sectionSequence
      ]" />

      <log level="info" message="Updated page section: ${pageSectionId} for owner: ${ownerPartyId}" />
    </actions>
  </service>

  <!-- deletePageSection: Delete section -->
  <service verb="delete" noun="PageSection" authenticate="true">
    <description>Delete page section. Owner party ID is automatically determined from authenticated user context.</description>
    <in-parameters>
      <parameter name="pageSectionId" type="String" required="true">
        <description>Section ID to delete</description>
      </parameter>
    </in-parameters>
    <out-parameters>
      <parameter name="deletedCount" type="Integer">
        <description>Number of records deleted</description>
      </parameter>
    </out-parameters>
    <actions>
      <!-- Get owner party ID from authenticated user context -->
      <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
        out-map="context" />

      <!-- Verify section exists and belongs to owner's landing page -->
      <entity-find-one entity-name="PageSection" value-field="existingSection">
        <field-map field-name="pageSectionId" from="pageSectionId" />
      </entity-find-one>

      <if condition="!existingSection">
        <return error="true" message="Page section not found" />
      </if>

      <!-- Verify the section's landing page belongs to owner -->
      <entity-find-one entity-name="LandingPage" value-field="landingPage">
        <field-map field-name="landingPageId" from="existingSection.landingPageId" />
        <field-map field-name="ownerPartyId" from="ownerPartyId" />
      </entity-find-one>

      <if condition="!landingPage">
        <return error="true" message="Access denied to this page section" />
      </if>

      <!-- Delete the section -->
      <service-call name="delete#PageSection" in-map="[pageSectionId: pageSectionId]" />
      <set field="deletedCount" value="1" type="Integer" />

      <log level="info" message="Deleted page section: ${pageSectionId} for owner: ${ownerPartyId}" />
    </actions>
  </service>

  <!-- listPageSections: Get sections for a page -->
  <service verb="list" noun="PageSections" authenticate="false">
    <description>List all sections for a landing page, ordered by sequence</description>
    <in-parameters>
      <parameter name="landingPageId" type="String" required="true">
        <description>Landing page ID</description>
      </parameter>
    </in-parameters>
    <out-parameters>
      <parameter name="sections" type="List">
        <description>List of page sections ordered by sequence</description>
        <parameter name="landingPageSectionId" />
        <parameter name="pageSectionId" />
        <parameter name="pseudoId" />
        <parameter name="landingPageId" />
        <parameter name="sectionSequence" type="Integer" />
        <parameter name="sectionTitle" />
        <parameter name="sectionDescription" />
        <parameter name="sectionImageUrl" />
        <parameter name="createdDate" type="Timestamp" />
      </parameter>
    </out-parameters>
    <actions>
      <!-- Get owner party ID from authenticated user context -->
      <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
        out-map="context" />

      <!-- Find all sections for the landing page -->
      <entity-find entity-name="PageSection" list="sectionsList">
        <econdition field-name="landingPageId" from="landingPageId" />
        <order-by field-name="sectionSequence" />
      </entity-find>

      <!-- Map pageSectionId to landingPageSectionId for frontend compatibility -->
      <set field="sections" from="[]" />
      <iterate list="sectionsList" entry="section">
        <script>
          Map sectionMap = section.getMap()
          sectionMap.put('landingPageSectionId', section.pageSectionId)
          sections.add(sectionMap)
        </script>
      </iterate>
    </actions>
  </service>

  <!-- ============================================ -->
  <!-- CREDIBILITY SERVICES (4 services) -->
  <!-- ============================================ -->

  <!-- getCredibilityInfo: Get credibility info for a landing page -->
  <service verb="get" noun="CredibilityInfo" authenticate="false">
    <description>Get credibility information for a landing page, including statistics</description>
    <in-parameters>
      <parameter name="landingPageId" type="String" required="true">
        <description>Landing page ID</description>
      </parameter>
    </in-parameters>
    <out-parameters>
      <parameter name="credibilityInfoList" type="List">
        <description>List of credibility info (typically one per page)</description>
        <parameter name="credibilityInfoId" />
        <parameter name="pseudoId" />
        <parameter name="landingPageId" />
        <parameter name="creatorBio" />
        <parameter name="backgroundText" />
        <parameter name="creatorImageUrl" />
        <parameter name="createdDate" type="Timestamp" />
        <parameter name="statistics" type="List">
          <description>List of credibility statistics</description>
          <parameter name="credibilityStatisticId" />
          <parameter name="statistic" />
          <parameter name="sequence" type="Integer" />
          <parameter name="createdDate" type="Timestamp" />
        </parameter>
      </parameter>
    </out-parameters>
    <actions>
      <!-- Get owner party ID from authenticated user context -->
      <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
        out-map="context" />

      <!-- Use view entity to get credibility info with statistics in one query -->
      <entity-find entity-name="growerp.landing.CredibilityInfoAndStatistics" list="viewResults">
        <econdition field-name="landingPageId" from="landingPageId" />
        <order-by field-name="credibilityInfoId" />
        <order-by field-name="sequence" />
      </entity-find>

      <!-- Group results by credibilityInfoId and nest statistics -->
      <script><![CDATA[
        credibilityInfoList = []
        Map<String, Map> credibilityMap = [:]
        
        for (def row : viewResults) {
          String credInfoId = row.credibilityInfoId
          
          // Create or get credibility info entry
          if (!credibilityMap.containsKey(credInfoId)) {
            Map credInfo = [
              credibilityInfoId: row.credibilityInfoId,
              pseudoId: row.pseudoId,
              landingPageId: row.landingPageId,
              creatorBio: row.creatorBio,
              backgroundText: row.backgroundText,
              creatorImageUrl: row.creatorImageUrl,
              createdDate: row.createdDate,
              statistics: []
            ]
            credibilityMap.put(credInfoId, credInfo)
            credibilityInfoList.add(credInfo)
          }
          
          // Add statistic if present (join is optional, so may be null)
          if (row.credibilityStatisticId) {
            Map statistic = [
              credibilityStatisticId: row.credibilityStatisticId,
              pseudoId: row.statisticPseudoId,
              statistic: row.statistic,
              sequence: row.sequence,
              createdDate: row.statisticCreatedDate
            ]
            credibilityMap.get(credInfoId).statistics.add(statistic)
          }
        }
      ]]></script>

      <log level="info"
        message="Retrieved ${credibilityInfoList.size()} credibility info records for landing page ${landingPageId}" />
    </actions>
  </service>

  <!-- createCredibilityInfo: Add credibility section -->
  <service verb="create" noun="CredibilityInfo" authenticate="true">
    <description>Create credibility/bio section for landing page. Owner party ID is automatically determined from authenticated user context.</description>
    <in-parameters>
      <parameter name="landingPageId" type="String" required="true">
        <description>Landing page ID</description>
      </parameter>
      <parameter name="creatorBio" type="String" required="true">
        <description>Creator bio text</description>
      </parameter>
      <parameter name="backgroundText">
        <description>Background/experience text</description>
      </parameter>
      <parameter name="creatorImageUrl">
        <description>Optional creator image URL</description>
      </parameter>
    </in-parameters>
    <out-parameters>
      <parameter name="credibilityInfoId">
        <description>Created credibility ID</description>
      </parameter>
      <parameter name="pseudoId">
        <description>Created credibility pseudoId</description>
      </parameter>
    </out-parameters>
    <actions>
      <!-- Get owner party ID from authenticated user context -->
      <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
        out-map="context" />

      <!-- Verify landing page exists and belongs to owner -->
      <entity-find-one entity-name="LandingPage" value-field="landingPage">
        <field-map field-name="landingPageId" from="landingPageId" />
        <field-map field-name="ownerPartyId" from="ownerPartyId" />
      </entity-find-one>

      <if condition="!landingPage">
        <return error="true" message="Landing page not found or access denied" />
      </if>

      <!-- Check if credibility info already exists for this page -->
      <entity-find entity-name="CredibilityInfo" list="existingCredibility">
        <econdition field-name="landingPageId" from="landingPageId" />
      </entity-find>

      <if condition="existingCredibility">
        <return error="true"
          message="Credibility info already exists for this page. Use update instead." />
      </if>

      <!-- Generate unique IDs -->
      <set field="credibilityInfoId"
        from="ec.entity.sequencedIdPrimary('CredibilityInfo', null, null)" />
      <set field="pseudoId" from="'cred_' + System.currentTimeMillis()" />

      <!-- Create credibility info record -->
      <service-call name="create#CredibilityInfo"
        in-map="[
        credibilityInfoId: credibilityInfoId,
        pseudoId: pseudoId,
        landingPageId: landingPageId,
        creatorBio: creatorBio,
        backgroundText: backgroundText,
        creatorImageUrl: creatorImageUrl,
        createdDate: ec.user.nowTimestamp
      ]" />

      <log level="info"
        message="Created credibility info: ${credibilityInfoId} for page: ${landingPageId}" />
    </actions>
  </service>

  <!-- updateCredibilityInfo: Update credibility section -->
  <service verb="update" noun="CredibilityInfo" authenticate="true">
    <description>Update credibility/bio section content. Owner party ID is automatically determined from authenticated user context.</description>
    <in-parameters>
      <parameter name="credibilityInfoId" type="String" required="true">
        <description>Credibility ID to update</description>
      </parameter>
      <parameter name="creatorBio">
        <description>New creator bio</description>
      </parameter>
      <parameter name="backgroundText">
        <description>New background text</description>
      </parameter>
      <parameter name="creatorImageUrl">
        <description>New creator image URL</description>
      </parameter>
    </in-parameters>
    <out-parameters>
      <parameter name="credibilityInfoId">
        <description>Updated credibility ID</description>
      </parameter>
    </out-parameters>
    <actions>
      <!-- Get owner party ID from authenticated user context -->
      <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
        out-map="context" />

      <!-- Verify credibility info exists and belongs to owner's landing page -->
      <entity-find-one entity-name="CredibilityInfo" value-field="existingCredibility">
        <field-map field-name="credibilityInfoId" from="credibilityInfoId" />
      </entity-find-one>

      <if condition="!existingCredibility">
        <return error="true" message="Credibility info not found" />
      </if>

      <!-- Verify the credibility's landing page belongs to owner -->
      <entity-find-one entity-name="LandingPage" value-field="landingPage">
        <field-map field-name="landingPageId" from="existingCredibility.landingPageId" />
        <field-map field-name="ownerPartyId" from="ownerPartyId" />
      </entity-find-one>

      <if condition="!landingPage">
        <return error="true" message="Access denied to this credibility info" />
      </if>

      <!-- Update credibility info with provided fields -->
      <service-call name="update#CredibilityInfo"
        in-map="[
        credibilityInfoId: credibilityInfoId,
        creatorBio: creatorBio ?: existingCredibility.creatorBio,
        backgroundText: backgroundText,
        creatorImageUrl: creatorImageUrl
      ]" />

      <log level="info"
        message="Updated credibility info: ${credibilityInfoId} for owner: ${ownerPartyId}" />
    </actions>
  </service>

  <!-- deleteCredibilityInfo: Delete credibility section -->
  <service verb="delete" noun="CredibilityInfo" authenticate="true">
    <description>Delete credibility/bio section and all statistics. Owner party ID is automatically determined from authenticated user context.</description>
    <in-parameters>
      <parameter name="credibilityInfoId" type="String" required="true">
        <description>Credibility ID to delete</description>
      </parameter>
    </in-parameters>
    <out-parameters>
      <parameter name="deletedCount" type="Integer">
        <description>Total records deleted (credibility + statistics)</description>
      </parameter>
    </out-parameters>
    <actions>
      <!-- Get owner party ID from authenticated user context -->
      <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
        out-map="context" />

      <!-- Verify credibility info exists and belongs to owner's landing page -->
      <entity-find-one entity-name="CredibilityInfo" value-field="existingCredibility">
        <field-map field-name="credibilityInfoId" from="credibilityInfoId" />
      </entity-find-one>

      <if condition="!existingCredibility">
        <return error="true" message="Credibility info not found" />
      </if>

      <!-- Verify the credibility's landing page belongs to owner -->
      <entity-find-one entity-name="LandingPage" value-field="landingPage">
        <field-map field-name="landingPageId" from="existingCredibility.landingPageId" />
        <field-map field-name="ownerPartyId" from="ownerPartyId" />
      </entity-find-one>

      <if condition="!landingPage">
        <return error="true" message="Access denied to this credibility info" />
      </if>

      <set field="deletedCount" value="0" type="Integer" />

      <!-- Delete all related statistics first -->
      <entity-find entity-name="CredibilityStatistic" list="statisticsToDelete">
        <econdition field-name="credibilityInfoId" from="credibilityInfoId" />
      </entity-find>
      <iterate list="statisticsToDelete" entry="statistic">
        <service-call name="delete#CredibilityStatistic"
          in-map="[credibilityStatisticId: statistic.credibilityStatisticId]" />
        <set field="deletedCount" from="deletedCount + 1" />
      </iterate>

      <!-- Delete the credibility info -->
      <service-call name="delete#CredibilityInfo" in-map="[credibilityInfoId: credibilityInfoId]" />
      <set field="deletedCount" from="deletedCount + 1" />

      <log level="info"
        message="Deleted credibility info: ${credibilityInfoId} and ${deletedCount} related records for owner: ${ownerPartyId}" />
    </actions>
  </service>

  <!-- ============================================ -->
  <!-- CREDIBILITY STATISTIC SERVICES (2 services) -->
  <!-- ============================================ -->

  <!-- addCredibilityStatistic: Add supporting statistic -->
  <service verb="add" noun="CredibilityStatistic" authenticate="true">
    <description>Add a supporting statistic to credibility section. Owner party ID is automatically determined from authenticated user context.</description>
    <in-parameters>
      <parameter name="credibilityInfoId" type="String" required="true">
        <description>Credibility ID</description>
      </parameter>
      <parameter name="statistic" type="String" required="true">
        <description>Statistic text (e.g., "100+ customers")</description>
      </parameter>
    </in-parameters>
    <out-parameters>
      <parameter name="credibilityStatisticId">
        <description>Created statistic ID</description>
      </parameter>
    </out-parameters>
    <actions>
      <!-- Get owner party ID from authenticated user context -->
      <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
        out-map="context" />

      <!-- Verify credibility info exists and belongs to owner's landing page -->
      <entity-find-one entity-name="CredibilityInfo" value-field="credibilityInfo">
        <field-map field-name="credibilityInfoId" from="credibilityInfoId" />
      </entity-find-one>

      <if condition="!credibilityInfo">
        <return error="true" message="Credibility info not found" />
      </if>

      <!-- Verify the credibility's landing page belongs to owner -->
      <entity-find-one entity-name="LandingPage" value-field="landingPage">
        <field-map field-name="landingPageId" from="credibilityInfo.landingPageId" />
        <field-map field-name="ownerPartyId" from="ownerPartyId" />
      </entity-find-one>

      <if condition="!landingPage">
        <return error="true" message="Access denied to this credibility info" />
      </if>

      <!-- Generate unique ID -->
      <set field="credibilityStatisticId"
        from="ec.entity.sequencedIdPrimary('CredibilityStatistic', null, null)" />

      <!-- Create statistic record -->
      <service-call name="create#CredibilityStatistic"
        in-map="[
        credibilityStatisticId: credibilityStatisticId,
        credibilityInfoId: credibilityInfoId,
        statistic: statistic,
        createdDate: ec.user.nowTimestamp
      ]" />

      <log level="info"
        message="Added credibility statistic: ${credibilityStatisticId} for credibility: ${credibilityInfoId}" />
    </actions>
  </service>

  <!-- removeCredibilityStatistic: Remove statistic -->
  <service verb="remove" noun="CredibilityStatistic" authenticate="true">
    <description>Remove a credibility statistic. Owner party ID is automatically determined from authenticated user context.</description>
    <in-parameters>
      <parameter name="credibilityStatisticId" type="String" required="true">
        <description>Statistic ID to delete</description>
      </parameter>
    </in-parameters>
    <out-parameters>
      <parameter name="deletedCount" type="Integer">
        <description>Number of records deleted</description>
      </parameter>
    </out-parameters>
    <actions>
      <!-- Get owner party ID from authenticated user context -->
      <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
        out-map="context" />

      <!-- Verify statistic exists and belongs to owner's credibility -->
      <entity-find-one entity-name="CredibilityStatistic" value-field="existingStatistic">
        <field-map field-name="credibilityStatisticId" from="credibilityStatisticId" />
      </entity-find-one>

      <if condition="!existingStatistic">
        <return error="true" message="Credibility statistic not found" />
      </if>

      <!-- Verify the statistic's credibility belongs to owner's landing page -->
      <entity-find-one entity-name="CredibilityInfo" value-field="credibilityInfo">
        <field-map field-name="credibilityInfoId" from="existingStatistic.credibilityInfoId" />
      </entity-find-one>

      <entity-find-one entity-name="LandingPage" value-field="landingPage">
        <field-map field-name="landingPageId" from="credibilityInfo.landingPageId" />
        <field-map field-name="ownerPartyId" from="ownerPartyId" />
      </entity-find-one>

      <if condition="!landingPage">
        <return error="true" message="Access denied to this credibility statistic" />
      </if>

      <!-- Delete the statistic -->
      <service-call name="delete#CredibilityStatistic"
        in-map="[credibilityStatisticId: credibilityStatisticId]" />
      <set field="deletedCount" value="1" type="Integer" />

      <log level="info"
        message="Removed credibility statistic: ${credibilityStatisticId} for owner: ${ownerPartyId}" />
    </actions>
  </service>

  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- AI LANDING PAGE GENERATION SERVICES -->
  <!-- ============================================ -->

  <!-- generateLandingPageWithAI: Generate landing page with Gemini AI -->
  <service verb="generate" noun="LandingPageWithAI" authenticate="true">
    <description>Generate landing page content using Gemini AI and create directly in database</description>
    <in-parameters>
      <parameter name="businessDescription" type="String" required="true">
        <description>Description of the business (20-500 characters)</description>
      </parameter>
      <parameter name="targetAudience" type="String">
        <description>Target audience for the landing page (optional)</description>
      </parameter>
      <parameter name="industry" type="String">
        <description>Industry or market segment (optional, auto-detected if not provided)</description>
      </parameter>
      <parameter name="tone" type="String" default="professional">
        <description>Tone of content: professional|casual|inspirational</description>
      </parameter>
      <parameter name="numSections" type="Integer" default="5">
        <description>Number of page sections to generate (3-7)</description>
      </parameter>
    </in-parameters>
    <out-parameters>
      <parameter name="landingPage" type="Map">
        <description>Created landing page object with all sections</description>
      </parameter>
      <parameter name="sectionsCreated" type="Integer">
        <description>Number of sections created</description>
      </parameter>
    </out-parameters>
    <actions>
      <script location="component://growerp/service/generateLandingPageWithAI.groovy" />
    </actions>
  </service>

  <!-- ============================================ -->
</services>