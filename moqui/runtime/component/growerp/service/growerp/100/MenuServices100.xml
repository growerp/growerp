<?xml version="1.0" encoding="UTF-8"?>
<!--
Menu Configuration Services for GrowERP Dynamic Menu System
Service definitions for menu configuration and menu item management
- Uses unified MenuItem entity with recursive parent/child relationships
- Supports dual-ID lookup: menuConfigurationId (system-wide) or appId+userLoginId (tenant-unique)
- All services enforce multi-tenant isolation via ownerPartyId
-->
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">

  <!-- ============================================ -->
  <!-- MENU CONFIGURATION SERVICES -->
  <!-- ============================================ -->

  <!-- getMenuConfiguration: Retrieve single menu configuration -->
  <service verb="get" noun="MenuConfiguration" authenticate="true">
    <description>Get menu configuration by ID or appId. Returns configuration with all menu items in hierarchical structure.</description>
    <in-parameters>
      <parameter name="menuConfigurationId">
        <description>Menu configuration ID (system-wide unique)</description>
      </parameter>
      <parameter name="appId">
        <description>Application identifier (e.g., 'admin', 'freelance', 'hotel')</description>
      </parameter>
      <parameter name="userVersion" type="Boolean">
        <description>If true, return user-specific configuration. If false/null, return seed data.</description>
      </parameter>
    </in-parameters>
    <out-parameters>
      <parameter name="menuConfigurationId" />
      <parameter name="appId" />
      <parameter name="userId" />
      <parameter name="name" />
      <parameter name="description" />
      <parameter name="isActive" type="Boolean" />
      <parameter name="createdDate" type="Timestamp" />
      <parameter name="lastUpdatedStamp" type="Timestamp" />
      <parameter name="menuItems" type="List">
        <description>List of top-level menu items with nested children</description>
      </parameter>
    </out-parameters>
    <actions>
      <service-call out-map="context"
        name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" />

      <!-- When userVersion=true, use authenticated user's context for user-specific config -->
      <if condition="userVersion">
        <set field="lookupUserId" from="ec.user.userId" />
        <set field="lookupOwnerPartyId" from="ownerPartyId" />
      </if>

      <entity-find entity-name="growerp.menu.MenuConfiguration" list="userConfigs">
        <field-map field-name="menuConfigurationId" from="menuConfigurationId" ignore-if-empty="true"/>
        <econdition field-name="appId" from="appId" ignore-if-empty="true"/>
        <econdition field-name="userId" from="lookupUserId" ignore-if-empty="true"/>
        <econdition field-name="ownerPartyId" from="lookupOwnerPartyId" ignore-if-empty="true"/>
      </entity-find>

      <!-- If user-specific config not found and userVersion was requested, fall back to seed data -->
      <if condition="!userConfigs">
        <entity-find entity-name="growerp.menu.MenuConfiguration" list="userConfigs">
          <econdition field-name="appId" from="appId"/>
        </entity-find>
      </if>

      <!-- If still not found, return error -->
      <if condition="!userConfigs">
        <return error="true"
          message="Menu configuration not found: menuConfigurationId=$menuConfigurationId, appId=$appId, userVersion=$userVersion" />
      </if>

      <set field="config" from="userConfigs[0]" />

      <!-- Get top-level menu items (those with no parent) for this configuration -->
      <entity-find entity-name="growerp.menu.MenuItem" list="topLevelItems">
        <econdition field-name="menuConfigurationId" from="config.menuConfigurationId" />
        <econdition field-name="parentMenuItemId" operator="is-null" />
        <order-by field-name="sequenceNum" />
      </entity-find>

      <!-- Build response structure with recursive children -->
      <script>
        import java.text.SimpleDateFormat
        def isoFormat = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSSZ")
        
        // Recursive function to build menu item tree
        def buildMenuItem
        buildMenuItem = { item ->
          // Get children
          def childItems = ec.entity.find("growerp.menu.MenuItem")
              .condition("parentMenuItemId", item.menuItemId)
              .orderBy("sequenceNum")
              .list()
          
          List children = []
          childItems.each { child ->
            children.add(buildMenuItem(child))
          }
          // Sort children by sequence
          children.sort { a, b -> ((a.sequenceNum ?: 0) as Integer).compareTo((b.sequenceNum ?: 0) as Integer) }
          
          String title = (item.title != null ? item.title.toString() : '')
          // Capitalize first letter of title
          if (title.length() > 0) {
              title = title.substring(0, 1).toUpperCase() + title.substring(1)
          }
          
          return [
            menuItemId: item.menuItemId,
            menuConfigurationId: item.menuConfigurationId,
            parentMenuItemId: item.parentMenuItemId,
            itemKey: item.itemKey,
            title: title,
            route: item.route,
            iconName: item.iconName,
            widgetName: item.widgetName,
            image: item.image,
            selectedImage: item.selectedImage,
            userGroupsJson: item.userGroupsJson,
            sequenceNum: item.sequenceNum,
            isActive: item.isActive == 'Y',
            children: children
          ]
        }
        
        Map configMap = [
          menuConfigurationId: config.menuConfigurationId,
          appId: (config.appId != null ? config.appId.toString() : ''),
          userId: config.userId,
          name: (config.name != null ? config.name.toString() : ''),
          description: config.description,
          isActive: config.isActive == 'Y',
          createdDate: (config.createdDate != null ? isoFormat.format(config.createdDate) : null),
          lastUpdatedStamp: (config.lastUpdatedStamp != null ? isoFormat.format(config.lastUpdatedStamp) : null)
        ]
        
        // Build list of top-level menu items with their children
        List menuItems = []
        topLevelItems.each { item ->
          menuItems.add(buildMenuItem(item))
        }
        
        // Sort by sequenceNum
        menuItems.sort { a, b -> ((a.sequenceNum ?: 0) as Integer).compareTo((b.sequenceNum ?: 0) as Integer) }
        
        configMap.put('menuItems', menuItems)
        context.putAll(configMap)
      </script>
    </actions>
  </service>

  <!-- listMenuConfigurations: Get all menu configurations for tenant -->
  <service verb="list" noun="MenuConfigurations" authenticate="true">
    <description>List all menu configurations with pagination and optional filtering. Results automatically filtered by authenticated user's company.</description>
    <in-parameters>
      <parameter name="menuConfigurationId" />
      <parameter name="appId">
        <description>Optional app ID filter</description>
      </parameter>
      <parameter name="userId">
        <description>Optional user ID filter</description>
      </parameter>
      <parameter name="isActive">
        <description>Optional active status filter (Y/N)</description>
      </parameter>
      <parameter name="start" type="Integer" default-value="0">
        <description>Starting index (0-based)</description>
      </parameter>
      <parameter name="limit" type="Integer" default-value="20">
        <description>Results per page</description>
      </parameter>
      <parameter name="search">
        <description>Optional search string for name/appId</description>
      </parameter>
    </in-parameters>
    <out-parameters>
      <parameter name="menuConfigurations" type="List">
        <description>List of menu configuration objects</description>
      </parameter>
      <parameter name="totalResults" type="Integer" />
      <parameter name="start" type="Integer" />
      <parameter name="limit" type="Integer" />
    </out-parameters>
    <actions>
      <service-call out-map="context"
        name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" />

      <if condition="search">
        <set field="search" value="%$search%" />
      </if>

      <entity-find entity-name="growerp.menu.MenuConfiguration" list="configsList" offset="start"
        limit="limit">
        <econdition field-name="menuConfigurationId" ignore-if-empty="true" />
        <econdition field-name="ownerPartyId" from="ownerPartyId" ignore-if-empty="true" />
        <econdition field-name="appId" ignore-if-empty="true" />
        <econdition field-name="userId" ignore-if-empty="true" />
        <econdition field-name="isActive" ignore-if-empty="true" />
        <econditions combine="or">
          <econdition field-name="appId" operator="like" from="search"
            ignore-if-empty="true" ignore-case="true" />
          <econdition field-name="name" operator="like" from="search"
            ignore-if-empty="true" ignore-case="true" />
        </econditions>
        <order-by field-name="-lastUpdatedStamp" />
      </entity-find>

      <entity-find-count entity-name="growerp.menu.MenuConfiguration" count-field="totalResults">
        <econdition field-name="ownerPartyId" from="ownerPartyId" ignore-if-empty="true" />
        <econdition field-name="appId" ignore-if-empty="true" />
        <econdition field-name="isActive" ignore-if-empty="true" />
        <econdition field-name="name" operator="like" from="search" ignore-if-empty="true" />
      </entity-find-count>

      <set field="menuConfigurations" from="[]" />
      <iterate list="configsList" entry="config">
        <entity-find-count entity-name="growerp.menu.MenuItem" count-field="itemCount">
          <econdition field-name="menuConfigurationId" from="config.menuConfigurationId" />
          <econdition field-name="parentMenuItemId" operator="is-null" />
          <econdition field-name="isActive" value="Y" />
        </entity-find-count>

        <set field="configMap"
          from="[
          menuConfigurationId: config.menuConfigurationId,
          appId: config.appId,
          userId: config.userId,
          name: config.name,
          description: config.description,
          isActive: config.isActive,
          createdDate: config.createdDate,
          lastUpdatedStamp: config.lastUpdatedStamp,
          menuItemCount: itemCount
        ]" />
        <script>menuConfigurations.add(configMap)</script>
      </iterate>
    </actions>
  </service>

  <!-- createMenuConfiguration: Create new menu configuration -->
  <service verb="create" noun="MenuConfiguration" authenticate="true">
    <description>Create new menu configuration for an application or user</description>
    <in-parameters>
      <parameter name="appId" required="true" />
      <parameter name="userId" />
      <parameter name="name" required="true" />
      <parameter name="description" />
      <parameter name="isActive" default-value="Y" />
    </in-parameters>
    <out-parameters>
      <parameter name="menuConfigurationId" />
      <parameter name="appId" />
      <parameter name="userId" />
      <parameter name="name" />
      <parameter name="description" />
      <parameter name="isActive" />
      <parameter name="createdDate" type="Timestamp" />
    </out-parameters>
    <actions>
      <service-call out-map="context"
        name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" />
      
      <service-call name="create#growerp.menu.MenuConfiguration" out-map="createOut"
        in-map="[
        appId: appId,
        userId: userId,
        ownerPartyId: ownerPartyId,
        name: name,
        description: description,
        isActive: isActive,
        createdDate: ec.user.nowTimestamp,
        lastUpdatedStamp: ec.user.nowTimestamp
      ]" />

      <set field="menuConfigurationId" from="createOut.menuConfigurationId" />

      <service-call name="growerp.100.MenuServices100.list#MenuConfigurations"
        in-map="[menuConfigurationId: menuConfigurationId, limit: 1]" out-map="listOut" />

      <if condition="listOut.menuConfigurations">
        <script>
          context.putAll(listOut.menuConfigurations[0])
        </script>
      </if>
    </actions>
  </service>

  <!-- updateMenuConfiguration: Update existing menu configuration -->
  <service verb="update" noun="MenuConfiguration" authenticate="true">
    <description>Update menu configuration (name, description, active status)</description>
    <in-parameters>
      <parameter name="menuConfigurationId" required="true" />
      <parameter name="name" />
      <parameter name="description" />
      <parameter name="isActive" />
    </in-parameters>
    <out-parameters>
      <parameter name="menuConfigurationId" />
      <parameter name="appId" />
      <parameter name="userId" />
      <parameter name="name" />
      <parameter name="description" />
      <parameter name="isActive" />
      <parameter name="lastUpdatedStamp" type="Timestamp" />
    </out-parameters>
    <actions>
      <service-call out-map="context"
        name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" />

      <entity-find-one entity-name="growerp.menu.MenuConfiguration" value-field="existingConfig">
        <field-map field-name="menuConfigurationId" from="menuConfigurationId" />
      </entity-find-one>

      <if condition="!existingConfig">
        <return error="true" message="Menu configuration not found" />
      </if>

      <service-call name="update#growerp.menu.MenuConfiguration"
        in-map="[
        menuConfigurationId: menuConfigurationId,
        name: name ?: existingConfig.name,
        description: description,
        isActive: isActive ?: existingConfig.isActive,
        lastUpdatedStamp: ec.user.nowTimestamp
      ]" />

      <service-call name="growerp.100.MenuServices100.list#MenuConfigurations"
        in-map="[menuConfigurationId: menuConfigurationId, limit: 1]" out-map="listOut" />

      <if condition="listOut.menuConfigurations">
        <script>
          context.putAll(listOut.menuConfigurations[0])
        </script>
      </if>
    </actions>
  </service>

  <!-- deleteMenuConfiguration: Delete menu configuration and cascade -->
  <service verb="delete" noun="MenuConfiguration" authenticate="true">
    <description>Delete menu configuration and all related menu items (cascade delete).</description>
    <in-parameters>
      <parameter name="menuConfigurationId" required="true" />
    </in-parameters>
    <out-parameters>
      <parameter name="deletedCount" type="Integer" />
    </out-parameters>
    <actions>
      <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
        out-map="context" />

      <entity-find-one entity-name="growerp.menu.MenuConfiguration" value-field="existingConfig">
        <field-map field-name="menuConfigurationId" from="menuConfigurationId" />
      </entity-find-one>

      <if condition="!existingConfig">
        <return error="true" message="Menu configuration not found" />
      </if>

      <set field="deletedCount" value="0" type="Integer" />

      <!-- Delete all menu items for this configuration (children will cascade via Moqui) -->
      <entity-find entity-name="growerp.menu.MenuItem" list="itemsToDelete">
        <econdition field-name="menuConfigurationId" from="menuConfigurationId" />
      </entity-find>
      <iterate list="itemsToDelete" entry="item">
        <service-call name="delete#growerp.menu.MenuItem"
          in-map="[menuItemId: item.menuItemId]" />
        <set field="deletedCount" from="deletedCount + 1" />
      </iterate>

      <!-- Delete the configuration itself -->
      <service-call name="delete#growerp.menu.MenuConfiguration"
        in-map="[menuConfigurationId: menuConfigurationId]" />
      <set field="deletedCount" from="deletedCount + 1" />
    </actions>
  </service>

  <!-- ensureUserMenuConfiguration: Ensure user has their own configuration -->
  <service verb="ensure" noun="UserMenuConfiguration" authenticate="true">
    <description>Ensure user has their own menu configuration. If they're using seed data, clone it for them.</description>
    <in-parameters>
      <parameter name="menuConfigurationId" required="true" />
    </in-parameters>
    <out-parameters>
      <parameter name="userMenuConfigurationId" />
      <parameter name="wasCloned" type="Boolean" />
    </out-parameters>
    <actions>
      <service-call out-map="context"
        name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" />

      <entity-find-one entity-name="growerp.menu.MenuConfiguration" value-field="config">
        <field-map field-name="menuConfigurationId" from="menuConfigurationId" />
      </entity-find-one>

      <if condition="!config">
        <return error="true" message="Menu configuration not found: ${menuConfigurationId}" />
      </if>

      <!-- Check if this is seed data (userId is null) -->
      <if condition="config.userId == null">
        <!-- Check if user already has their own configuration for this app -->
        <entity-find entity-name="growerp.menu.MenuConfiguration" list="existingUserConfigs">
          <econdition field-name="appId" from="config.appId" />
          <econdition field-name="userId" from="ec.user.userId" />
          <econdition field-name="ownerPartyId" from="ownerPartyId" ignore-if-empty="true" />
        </entity-find>

        <if condition="existingUserConfigs">
          <set field="userMenuConfigurationId" from="existingUserConfigs[0].menuConfigurationId" />
          <set field="wasCloned" from="false" type="Boolean" />
          <else>
            <service-call name="growerp.100.MenuServices100.clone#MenuConfiguration"
              out-map="cloneOut"
              in-map="[sourceMenuConfigurationId: menuConfigurationId, name: config.name + ' (User Copy)']" />
            <set field="userMenuConfigurationId" from="cloneOut.menuConfigurationId" />
            <set field="wasCloned" from="true" type="Boolean" />
          </else>
        </if>
        <else>
          <set field="userMenuConfigurationId" from="menuConfigurationId" />
          <set field="wasCloned" from="false" type="Boolean" />
        </else>
      </if>
    </actions>
  </service>

  <!-- cloneMenuConfiguration: Clone configuration for user customization -->
  <service verb="clone" noun="MenuConfiguration" authenticate="true">
    <description>Clone an existing menu configuration for user customization.</description>
    <in-parameters>
      <parameter name="sourceMenuConfigurationId" required="true" />
      <parameter name="name" />
    </in-parameters>
    <out-parameters>
      <parameter name="menuConfigurationId" />
      <parameter name="appId" />
      <parameter name="userId" />
      <parameter name="name" />
    </out-parameters>
    <actions>
      <service-call out-map="context"
        name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" />
      <set field="currentUserId" from="ec.user.userId" />

      <entity-find-one entity-name="growerp.menu.MenuConfiguration" value-field="sourceConfig">
        <field-map field-name="menuConfigurationId" from="sourceMenuConfigurationId" />
      </entity-find-one>

      <if condition="!sourceConfig">
        <return error="true" message="Source menu configuration not found" />
      </if>

      <!-- Create new configuration for user -->
      <service-call name="growerp.100.MenuServices100.create#MenuConfiguration"
        in-map="[
        appId: sourceConfig.appId,
        userId: currentUserId,
        name: name ?: (sourceConfig.name + ' (Custom)'),
        description: 'Cloned from ' + sourceConfig.name,
        isActive: 'Y'
      ]"
        out-map="createOut" />

      <set field="newMenuConfigurationId" from="createOut.menuConfigurationId" />

      <!-- Clone all menu items recursively -->
      <entity-find entity-name="growerp.menu.MenuItem" list="sourceItems">
        <econdition field-name="menuConfigurationId" from="sourceMenuConfigurationId" />
        <order-by field-name="sequenceNum" />
      </entity-find>

      <!-- Build a map of old ID -> new ID for parent references -->
      <script>
        Map idMapping = [:]
        
        // First pass: create all items without parent references
        sourceItems.each { item ->
          def createResult = ec.service.sync().name("create#growerp.menu.MenuItem")
            .parameters([
              menuConfigurationId: newMenuConfigurationId,
              itemKey: item.itemKey,
              title: item.title,
              route: item.route,
              iconName: item.iconName,
              widgetName: item.widgetName,
              image: item.image,
              selectedImage: item.selectedImage,
              userGroupsJson: item.userGroupsJson,
              sequenceNum: item.sequenceNum,
              isActive: item.isActive
            ])
            .call()
          idMapping[item.menuItemId] = createResult.menuItemId
        }
        
        // Second pass: update parent references
        sourceItems.each { item ->
          if (item.parentMenuItemId != null) {
            def newId = idMapping[item.menuItemId]
            def newParentId = idMapping[item.parentMenuItemId]
            if (newId &amp;&amp; newParentId) {
              ec.service.sync().name("update#growerp.menu.MenuItem")
                .parameters([
                  menuItemId: newId,
                  parentMenuItemId: newParentId
                ])
                .call()
            }
          }
        }
      </script>

      <set field="menuConfigurationId" from="newMenuConfigurationId" />
      <set field="appId" from="sourceConfig.appId" />
      <set field="userId" from="currentUserId" />
      <set field="name" from="createOut.name" />
    </actions>
  </service>

  <!-- resetMenuConfiguration: Reset configuration to default -->
  <service verb="reset" noun="MenuConfiguration" authenticate="true">
    <description>Reset menu configuration to default by deleting user's custom configuration.</description>
    <in-parameters>
      <parameter name="menuConfigurationId" required="true" />
    </in-parameters>
    <out-parameters>
      <parameter name="menuConfigurationId" />
      <parameter name="appId" />
      <parameter name="name" />
      <parameter name="resetItemCount" type="Integer" />
    </out-parameters>
    <actions>
      <service-call out-map="context"
        name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" />

      <entity-find-one entity-name="growerp.menu.MenuConfiguration" value-field="config">
        <field-map field-name="menuConfigurationId" from="menuConfigurationId" />
      </entity-find-one>

      <if condition="!config">
        <return error="true" message="Menu configuration not found" />
      </if>

      <!-- If already on seed data, just return success - user is already using default -->
      <if condition="config.userId == null">
        <set field="appId" from="config.appId" />
        <set field="name" from="config.name" />
        <set field="resetItemCount" value="0" type="Integer" />
        <return message="Already using default configuration." />
      </if>

      <!-- Delete all menu items - children first to avoid FK constraint violations -->
      <entity-find entity-name="growerp.menu.MenuItem" list="existingItems">
        <econdition field-name="menuConfigurationId" from="menuConfigurationId" />
      </entity-find>

      <script>
        // Separate children and parents - delete children first
        def children = existingItems.findAll { it.parentMenuItemId != null }
        def parents = existingItems.findAll { it.parentMenuItemId == null }
        
        // Delete children first
        children.each { item ->
          ec.service.sync().name("delete#growerp.menu.MenuItem")
            .parameters([menuItemId: item.menuItemId])
            .call()
        }
        
        // Then delete parents
        parents.each { item ->
          ec.service.sync().name("delete#growerp.menu.MenuItem")
            .parameters([menuItemId: item.menuItemId])
            .call()
        }
      </script>

      <!-- Delete the configuration itself -->
      <service-call name="delete#growerp.menu.MenuConfiguration"
        in-map="[menuConfigurationId: menuConfigurationId]" />

      <set field="appId" from="config.appId" />
      <set field="name" from="config.name" />
      <set field="resetItemCount" from="existingItems.size()" type="Integer" />
    </actions>
  </service>

  <!-- ============================================ -->
  <!-- MENU ITEM SERVICES (UNIFIED) -->
  <!-- ============================================ -->

  <!-- createMenuItem: Add menu item to configuration -->
  <service verb="create" noun="MenuItem" authenticate="true">
    <description>Create new menu item within a configuration. Can be top-level or child of another item.</description>
    <in-parameters>
      <parameter name="menuConfigurationId" required="true" />
      <parameter name="parentMenuItemId">
        <description>Parent menu item ID for child items (null for top-level)</description>
      </parameter>
      <parameter name="itemKey" />
      <parameter name="title" required="true" />
      <parameter name="route" />
      <parameter name="iconName" />
      <parameter name="widgetName" />
      <parameter name="image" />
      <parameter name="selectedImage" />
      <parameter name="userGroupsJson" />
      <parameter name="sequenceNum" type="Integer" />
      <parameter name="isActive" default-value="Y" />
    </in-parameters>
    <out-parameters>
      <parameter name="menuItemId" />
      <parameter name="menuConfigurationId" />
      <parameter name="parentMenuItemId" />
      <parameter name="itemKey" />
      <parameter name="title" />
      <parameter name="route" />
      <parameter name="iconName" />
      <parameter name="widgetName" />
      <parameter name="sequenceNum" type="Integer" />
      <parameter name="isActive" />
      <parameter name="children" type="List" />
    </out-parameters>
    <actions>
      <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
        out-map="context" />

      <!-- Verify configuration exists -->
      <entity-find-one entity-name="growerp.menu.MenuConfiguration" value-field="config">
        <field-map field-name="menuConfigurationId" from="menuConfigurationId" />
      </entity-find-one>

      <if condition="!config">
        <return error="true" message="Menu configuration not found" />
      </if>

      <!-- Ensure user has their own configuration (clone seed data if needed) -->
      <service-call name="growerp.100.MenuServices100.ensure#UserMenuConfiguration"
        out-map="ensureOut"
        in-map="[menuConfigurationId: menuConfigurationId]" />

      <set field="targetMenuConfigurationId" from="ensureOut.userMenuConfigurationId" />

      <!-- If parent specified and config was cloned, find corresponding parent in new config -->
      <if condition="parentMenuItemId &amp;&amp; ensureOut.wasCloned">
        <entity-find-one entity-name="growerp.menu.MenuItem" value-field="origParent">
          <field-map field-name="menuItemId" from="parentMenuItemId" />
        </entity-find-one>
        <if condition="origParent">
          <entity-find entity-name="growerp.menu.MenuItem" list="newParents">
            <econdition field-name="menuConfigurationId" from="targetMenuConfigurationId" />
            <econdition field-name="title" from="origParent.title" />
          </entity-find>
          <if condition="newParents">
            <set field="parentMenuItemId" from="newParents[0].menuItemId" />
          </if>
        </if>
      </if>

      <!-- Auto-increment sequence if not provided -->
      <if condition="!sequenceNum">
        <entity-find entity-name="growerp.menu.MenuItem" list="existingItems">
          <econdition field-name="menuConfigurationId" from="targetMenuConfigurationId" />
          <econdition field-name="parentMenuItemId" from="parentMenuItemId" ignore-if-empty="true" />
          <econdition field-name="parentMenuItemId" operator="is-null" ignore="parentMenuItemId != null" />
          <select-field field-name="sequenceNum" />
          <order-by field-name="-sequenceNum" />
        </entity-find>
        <if condition="existingItems">
          <set field="sequenceNum" from="existingItems[0].sequenceNum + 10" />
          <else>
            <set field="sequenceNum" value="10" type="Integer" />
          </else>
        </if>
      </if>

      <!-- Create menu item -->
      <service-call name="create#growerp.menu.MenuItem" out-map="createOut"
        in-map="[
        menuConfigurationId: targetMenuConfigurationId,
        parentMenuItemId: parentMenuItemId,
        itemKey: itemKey,
        title: title,
        route: route,
        iconName: iconName,
        widgetName: widgetName,
        image: image,
        selectedImage: selectedImage,
        userGroupsJson: userGroupsJson,
        sequenceNum: sequenceNum,
        isActive: isActive
      ]" />

      <set field="menuItemId" from="createOut.menuItemId" />

      <!-- Fetch the complete menu item -->
      <entity-find-one entity-name="growerp.menu.MenuItem" value-field="menuItem">
        <field-map field-name="menuItemId" from="menuItemId" />
      </entity-find-one>

      <script>
        Map itemMap = menuItem.getMap()
        itemMap.put('children', [])  // New item has no children
        context.putAll(itemMap)
      </script>
    </actions>
  </service>

  <!-- updateMenuItem: Update menu item -->
  <service verb="update" noun="MenuItem" authenticate="true">
    <description>Update menu item content and display order.</description>
    <in-parameters>
      <parameter name="menuItemId" required="true" />
      <parameter name="parentMenuItemId" />
      <parameter name="itemKey" />
      <parameter name="title" />
      <parameter name="route" />
      <parameter name="iconName" />
      <parameter name="widgetName" />
      <parameter name="image" />
      <parameter name="selectedImage" />
      <parameter name="userGroupsJson" />
      <parameter name="sequenceNum" type="Integer" />
      <parameter name="isActive" />
    </in-parameters>
    <out-parameters>
      <parameter name="menuItemId" />
      <parameter name="menuConfigurationId" />
      <parameter name="parentMenuItemId" />
      <parameter name="title" />
      <parameter name="route" />
      <parameter name="iconName" />
      <parameter name="widgetName" />
      <parameter name="sequenceNum" type="Integer" />
      <parameter name="isActive" />
      <parameter name="children" type="List" />
    </out-parameters>
    <actions>
      <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
        out-map="context" />

      <entity-find-one entity-name="growerp.menu.MenuItem" value-field="existingItem">
        <field-map field-name="menuItemId" from="menuItemId" />
      </entity-find-one>

      <if condition="!existingItem">
        <return error="true" message="Menu item not found" />
      </if>

      <!-- Ensure user has their own configuration (clone seed data if needed) -->
      <service-call name="growerp.100.MenuServices100.ensure#UserMenuConfiguration"
        out-map="ensureOut"
        in-map="[menuConfigurationId: existingItem.menuConfigurationId]" />

      <!-- If cloned, find the corresponding item in new config -->
      <if condition="ensureOut.wasCloned">
        <entity-find entity-name="growerp.menu.MenuItem" list="newItems">
          <econdition field-name="menuConfigurationId" from="ensureOut.userMenuConfigurationId" />
          <econdition field-name="title" from="existingItem.title" />
        </entity-find>
        <if condition="newItems">
          <set field="menuItemId" from="newItems[0].menuItemId" />
          <set field="existingItem" from="newItems[0]" />
        </if>
      </if>

      <!-- Update menu item with provided fields -->
      <service-call name="update#growerp.menu.MenuItem"
        in-map="[
        menuItemId: menuItemId,
        parentMenuItemId: parentMenuItemId,
        itemKey: itemKey,
        title: title ?: existingItem.title,
        route: route,
        iconName: iconName,
        widgetName: widgetName,
        image: image,
        selectedImage: selectedImage,
        userGroupsJson: userGroupsJson,
        sequenceNum: sequenceNum ?: existingItem.sequenceNum,
        isActive: isActive ?: existingItem.isActive
      ]" />

      <!-- Fetch and return the updated item with its children -->
      <entity-find-one entity-name="growerp.menu.MenuItem" value-field="updatedItem">
        <field-map field-name="menuItemId" from="menuItemId" />
      </entity-find-one>

      <!-- Get children -->
      <entity-find entity-name="growerp.menu.MenuItem" list="childItems">
        <econdition field-name="parentMenuItemId" from="menuItemId" />
        <order-by field-name="sequenceNum" />
      </entity-find>

      <script>
        List children = []
        childItems.each { child ->
          children.add([
            menuItemId: child.menuItemId,
            title: child.title,
            iconName: child.iconName,
            widgetName: child.widgetName,
            image: child.image,
            isActive: child.isActive == 'Y',
            sequenceNum: child.sequenceNum
          ])
        }
        
        Map itemMap = updatedItem.getMap()
        itemMap.put('children', children)
        context.putAll(itemMap)
      </script>
    </actions>
  </service>

  <!-- deleteMenuItem: Delete menu item -->
  <service verb="delete" noun="MenuItem" authenticate="true">
    <description>Delete menu item and all its children (cascade delete).</description>
    <in-parameters>
      <parameter name="menuItemId" required="true" />
    </in-parameters>
    <out-parameters>
      <parameter name="deletedCount" type="Integer" />
    </out-parameters>
    <actions>
      <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
        out-map="context" />

      <entity-find-one entity-name="growerp.menu.MenuItem" value-field="existingItem">
        <field-map field-name="menuItemId" from="menuItemId" />
      </entity-find-one>

      <if condition="!existingItem">
        <return error="true" message="Menu item not found" />
      </if>

      <!-- Ensure user has their own configuration (clone seed data if needed) -->
      <service-call name="growerp.100.MenuServices100.ensure#UserMenuConfiguration"
        out-map="ensureOut"
        in-map="[menuConfigurationId: existingItem.menuConfigurationId]" />

      <!-- If cloned, find the corresponding item in new config -->
      <if condition="ensureOut.wasCloned">
        <entity-find entity-name="growerp.menu.MenuItem" list="newItems">
          <econdition field-name="menuConfigurationId" from="ensureOut.userMenuConfigurationId" />
          <econdition field-name="title" from="existingItem.title" />
        </entity-find>
        <if condition="newItems">
          <set field="menuItemId" from="newItems[0].menuItemId" />
        </if>
      </if>

      <set field="deletedCount" value="0" type="Integer" />

      <!-- Recursively delete children first -->
      <entity-find entity-name="growerp.menu.MenuItem" list="childItems">
        <econdition field-name="parentMenuItemId" from="menuItemId" />
      </entity-find>
      <iterate list="childItems" entry="child">
        <service-call name="growerp.100.MenuServices100.delete#MenuItem"
          in-map="[menuItemId: child.menuItemId]" out-map="childDeleteOut" />
        <set field="deletedCount" from="deletedCount + (childDeleteOut.deletedCount ?: 1)" />
      </iterate>

      <!-- Delete the item itself -->
      <service-call name="delete#growerp.menu.MenuItem"
        in-map="[menuItemId: menuItemId]" />
      <set field="deletedCount" from="deletedCount + 1" />
    </actions>
  </service>

  <!-- reorderMenuItems: Update sequence numbers for multiple items -->
  <service verb="reorder" noun="MenuItems" authenticate="true">
    <description>Update sequence numbers for multiple menu items in one operation (for drag-and-drop reordering).</description>
    <in-parameters>
      <parameter name="menuConfigurationId" required="true" />
      <parameter name="itemSequences" type="List" required="true">
        <description>List of {menuItemId, sequenceNum} pairs</description>
      </parameter>
    </in-parameters>
    <out-parameters>
      <parameter name="updatedCount" type="Integer" />
    </out-parameters>
    <actions>
      <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
        out-map="context" />

      <entity-find-one entity-name="growerp.menu.MenuConfiguration" value-field="config">
        <field-map field-name="menuConfigurationId" from="menuConfigurationId" />
      </entity-find-one>

      <if condition="!config">
        <return error="true" message="Menu configuration not found" />
      </if>

      <service-call name="growerp.100.MenuServices100.ensure#UserMenuConfiguration"
        out-map="ensureOut"
        in-map="[menuConfigurationId: menuConfigurationId]" />

      <set field="targetMenuConfigurationId" from="ensureOut.userMenuConfigurationId" />
      <set field="updatedCount" value="0" type="Integer" />

      <iterate list="itemSequences" entry="itemSeq">
        <if condition="ensureOut.wasCloned">
          <entity-find-one entity-name="growerp.menu.MenuItem" value-field="origItem">
            <field-map field-name="menuItemId" from="itemSeq.menuItemId" />
          </entity-find-one>
          <if condition="origItem">
            <entity-find entity-name="growerp.menu.MenuItem" list="clonedItems">
              <econdition field-name="menuConfigurationId" from="targetMenuConfigurationId" />
              <econdition field-name="title" from="origItem.title" />
            </entity-find>
            <if condition="clonedItems">
              <set field="itemSeq.menuItemId" from="clonedItems[0].menuItemId" />
            </if>
          </if>
        </if>
        <service-call name="update#growerp.menu.MenuItem"
          in-map="[
          menuItemId: itemSeq.menuItemId,
          sequenceNum: itemSeq.sequenceNum
        ]" />
        <set field="updatedCount" from="updatedCount + 1" />
      </iterate>
    </actions>
  </service>

  <!-- toggleMenuItemActive: Toggle active status -->
  <service verb="toggle" noun="MenuItemActive" authenticate="true">
    <description>Toggle menu item active status (show/hide in menu).</description>
    <in-parameters>
      <parameter name="menuItemId" required="true" />
    </in-parameters>
    <out-parameters>
      <parameter name="menuItemId" />
      <parameter name="isActive" />
    </out-parameters>
    <actions>
      <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner"
        out-map="context" />

      <entity-find-one entity-name="growerp.menu.MenuItem" value-field="item">
        <field-map field-name="menuItemId" from="menuItemId" />
      </entity-find-one>

      <if condition="!item">
        <return error="true" message="Menu item not found" />
      </if>

      <service-call name="growerp.100.MenuServices100.ensure#UserMenuConfiguration"
        out-map="ensureOut"
        in-map="[menuConfigurationId: item.menuConfigurationId]" />

      <if condition="ensureOut.wasCloned">
        <entity-find entity-name="growerp.menu.MenuItem" list="clonedItems">
          <econdition field-name="menuConfigurationId" from="ensureOut.userMenuConfigurationId" />
          <econdition field-name="title" from="item.title" />
        </entity-find>
        <if condition="clonedItems">
          <set field="menuItemId" from="clonedItems[0].menuItemId" />
          <set field="item" from="clonedItems[0]" />
        </if>
      </if>

      <set field="newIsActive" from="item.isActive == 'Y' ? 'N' : 'Y'" />

      <service-call name="update#growerp.menu.MenuItem"
        in-map="[
        menuItemId: menuItemId,
        isActive: newIsActive
      ]" />

      <set field="isActive" from="newIsActive" />
    </actions>
  </service>

</services>