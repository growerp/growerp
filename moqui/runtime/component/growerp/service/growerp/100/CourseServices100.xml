<?xml version="1.0" encoding="UTF-8"?>
<!--
This software is in the public domain under CC0 1.0 Universal plus a
Grant of Patent License.
-->
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">

    <!-- ========================================================= -->
    <!--  Course CRUD Services                                     -->
    <!-- ========================================================= -->

    <service verb="list" noun="Courses">
        <in-parameters>
            <parameter name="start" type="Integer" default="0"/>
            <parameter name="limit" type="Integer" default="20"/>
            <parameter name="filter" type="String"/>
            <parameter name="status" type="String"/>
        </in-parameters>
        <out-parameters>
            <parameter name="courses" type="List"/>
        </out-parameters>
        <actions>
            <if condition="filter?.trim()">
                <set field="filter" value="%${filter.trim()}%"/>
            </if>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" out-map="weightContext"/>
            <entity-find entity-name="growerp.course.Course" list="courseList">
                <econdition field-name="ownerPartyId" from="weightContext.ownerPartyId"/>
                <econdition field-name="status" ignore-if-empty="true"/>
                <econditions combine="or">
                    <econdition field-name="title" operator="like" from="filter" ignore-if-empty="true"/>
                    <econdition field-name="description" operator="like" from="filter" ignore-if-empty="true"/>
                </econditions>
                <order-by field-name="-lastModifiedDate"/>
            </entity-find>
            <!-- Build courses with nested modules and lessons -->
            <set field="courses" from="[]"/>
            <iterate list="courseList" entry="courseEntity">
                <!-- Get modules for this course -->
                <entity-find entity-name="growerp.course.CourseModule" list="moduleList">
                    <econdition field-name="courseId" from="courseEntity.courseId"/>
                    <order-by field-name="sequenceNum"/>
                </entity-find>
                <!-- Get lessons for each module -->
                <set field="modulesWithLessons" from="[]"/>
                <iterate list="moduleList" entry="module">
                    <entity-find entity-name="growerp.course.CourseLesson" list="lessonList">
                        <econdition field-name="moduleId" from="module.moduleId"/>
                        <order-by field-name="sequenceNum"/>
                    </entity-find>
                    <script>
                        modulesWithLessons.add([
                            moduleId: module.moduleId,
                            pseudoId: module.pseudoId,
                            courseId: module.courseId,
                            title: module.title,
                            description: module.description,
                            sequenceNum: module.sequenceNum,
                            estimatedDuration: module.estimatedDuration,
                            createdDate: module.createdDate,
                            lastModifiedDate: module.lastModifiedDate,
                            lessons: lessonList*.getMap()
                        ])
                    </script>
                </iterate>
                <script>
                    courses.add([
                        courseId: courseEntity.courseId,
                        pseudoId: courseEntity.pseudoId,
                        ownerPartyId: courseEntity.ownerPartyId,
                        title: courseEntity.title,
                        description: courseEntity.description,
                        objectives: courseEntity.objectives,
                        targetPersonaId: courseEntity.targetPersonaId,
                        difficulty: courseEntity.difficulty,
                        estimatedDuration: courseEntity.estimatedDuration,
                        status: courseEntity.status,
                        coverImageUrl: courseEntity.coverImageUrl,
                        createdDate: courseEntity.createdDate,
                        lastModifiedDate: courseEntity.lastModifiedDate,
                        modules: modulesWithLessons
                    ])
                </script>
            </iterate>
        </actions>
    </service>

    <service verb="get" noun="Course">
        <in-parameters>
            <parameter name="courseId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="course" type="Map"/>
        </out-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" out-map="context"/>
            <entity-find-one entity-name="growerp.course.Course" value-field="courseEntity">
                <field-map field-name="courseId"/>
            </entity-find-one>
            <if condition="courseEntity?.ownerPartyId != context.ownerPartyId">
                <message error="true">Course not found or access denied</message>
                <return/>
            </if>
            <!-- Get modules -->
            <entity-find entity-name="growerp.course.CourseModule" list="moduleList">
                <econdition field-name="courseId"/>
                <order-by field-name="sequenceNum"/>
            </entity-find>
            <!-- Get lessons for each module -->
            <set field="modulesWithLessons" from="[]"/>
            <iterate list="moduleList" entry="module">
                <entity-find entity-name="growerp.course.CourseLesson" list="lessonList">
                    <econdition field-name="moduleId" from="module.moduleId"/>
                    <order-by field-name="sequenceNum"/>
                </entity-find>
                <script>
                    modulesWithLessons.add([
                        moduleId: module.moduleId,
                        pseudoId: module.pseudoId,
                        title: module.title,
                        description: module.description,
                        sequenceNum: module.sequenceNum,
                        estimatedDuration: module.estimatedDuration,
                        lessons: lessonList*.getMap()
                    ])
                </script>
            </iterate>
            <set field="course" from="[
                courseId: courseEntity.courseId,
                pseudoId: courseEntity.pseudoId,
                ownerPartyId: courseEntity.ownerPartyId,
                title: courseEntity.title,
                description: courseEntity.description,
                objectives: courseEntity.objectives,
                targetPersonaId: courseEntity.targetPersonaId,
                difficulty: courseEntity.difficulty,
                estimatedDuration: courseEntity.estimatedDuration,
                status: courseEntity.status,
                coverImageUrl: courseEntity.coverImageUrl,
                createdDate: courseEntity.createdDate,
                lastModifiedDate: courseEntity.lastModifiedDate,
                modules: modulesWithLessons
            ]"/>
        </actions>
    </service>

    <service verb="create" noun="Course">
        <in-parameters>
            <parameter name="title" required="true"/>
            <parameter name="description"/>
            <parameter name="objectives"/>
            <parameter name="targetPersonaId"/>
            <parameter name="difficulty" default-value="BEGINNER"/>
            <parameter name="estimatedDuration" type="Integer"/>
            <parameter name="coverImageUrl"/>
        </in-parameters>
        <out-parameters>
            <parameter name="courseId"/>
            <parameter name="pseudoId"/>
        </out-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" out-map="context"/>
            <service-call name="growerp.100.GeneralServices100.getNext#PseudoId"
                in-map="[ownerPartyId: context.ownerPartyId, seqName: 'Course']" out-map="seqContext"/>
            <service-call name="create#growerp.course.Course" in-map="[
                pseudoId: seqContext.seqNum,
                ownerPartyId: context.ownerPartyId,
                title: title,
                description: description,
                objectives: objectives,
                targetPersonaId: targetPersonaId,
                difficulty: difficulty,
                estimatedDuration: estimatedDuration,
                status: 'DRAFT',
                coverImageUrl: coverImageUrl,
                createdDate: ec.user.nowTimestamp,
                lastModifiedDate: ec.user.nowTimestamp,
                createdByUserLogin: ec.user.username
            ]" out-map="createContext"/>
            <set field="courseId" from="createContext.courseId"/>
            <set field="pseudoId" from="seqContext.seqNum"/>
        </actions>
    </service>

    <service verb="update" noun="Course">
        <in-parameters>
            <parameter name="courseId" required="true"/>
            <parameter name="title"/>
            <parameter name="description"/>
            <parameter name="objectives"/>
            <parameter name="targetPersonaId"/>
            <parameter name="difficulty"/>
            <parameter name="estimatedDuration" type="Integer"/>
            <parameter name="status"/>
            <parameter name="coverImageUrl"/>
        </in-parameters>
        <out-parameters>
            <parameter name="courseId"/>
        </out-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" out-map="context"/>
            <entity-find-one entity-name="growerp.course.Course" value-field="courseEntity">
                <field-map field-name="courseId"/>
            </entity-find-one>
            <if condition="courseEntity?.ownerPartyId != context.ownerPartyId">
                <message error="true">Course not found or access denied</message>
                <return/>
            </if>
            <service-call name="update#growerp.course.Course" in-map="[
                courseId: courseId,
                title: title ?: courseEntity.title,
                description: description ?: courseEntity.description,
                objectives: objectives ?: courseEntity.objectives,
                targetPersonaId: targetPersonaId ?: courseEntity.targetPersonaId,
                difficulty: difficulty ?: courseEntity.difficulty,
                estimatedDuration: estimatedDuration ?: courseEntity.estimatedDuration,
                status: status ?: courseEntity.status,
                coverImageUrl: coverImageUrl ?: courseEntity.coverImageUrl,
                lastModifiedDate: ec.user.nowTimestamp
            ]"/>
        </actions>
    </service>

    <service verb="delete" noun="Course">
        <in-parameters>
            <parameter name="courseId" required="true"/>
        </in-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" out-map="context"/>
            <entity-find-one entity-name="growerp.course.Course" value-field="courseEntity">
                <field-map field-name="courseId"/>
            </entity-find-one>
            <if condition="courseEntity?.ownerPartyId != context.ownerPartyId">
                <message error="true">Course not found or access denied</message>
                <return/>
            </if>
            <!-- Delete related media -->
            <entity-delete-by-condition entity-name="growerp.course.CourseMedia">
                <econdition field-name="courseId"/>
            </entity-delete-by-condition>
            <!-- Delete progress -->
            <entity-delete-by-condition entity-name="growerp.course.CourseProgress">
                <econdition field-name="courseId"/>
            </entity-delete-by-condition>
            <!-- Delete lessons -->
            <entity-delete-by-condition entity-name="growerp.course.CourseLesson">
                <econdition field-name="courseId"/>
            </entity-delete-by-condition>
            <!-- Delete modules -->
            <entity-delete-by-condition entity-name="growerp.course.CourseModule">
                <econdition field-name="courseId"/>
            </entity-delete-by-condition>
            <!-- Delete course -->
            <entity-delete value-field="courseEntity"/>
        </actions>
    </service>

    <!-- ========================================================= -->
    <!--  Module CRUD Services                                     -->
    <!-- ========================================================= -->

    <service verb="create" noun="CourseModule">
        <in-parameters>
            <parameter name="courseId" required="true"/>
            <parameter name="title" required="true"/>
            <parameter name="description"/>
            <parameter name="sequenceNum" type="Integer"/>
            <parameter name="estimatedDuration" type="Integer"/>
        </in-parameters>
        <out-parameters>
            <parameter name="moduleId"/>
            <parameter name="pseudoId"/>
        </out-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" out-map="context"/>
            <entity-find-one entity-name="growerp.course.Course" value-field="courseEntity">
                <field-map field-name="courseId"/>
            </entity-find-one>
            <if condition="courseEntity?.ownerPartyId != context.ownerPartyId">
                <message error="true">Course not found or access denied</message>
                <return/>
            </if>
            <service-call name="growerp.100.GeneralServices100.getNext#PseudoId"
                in-map="[ownerPartyId: context.ownerPartyId, seqName: 'CourseModule']" out-map="seqContext"/>
            <if condition="!sequenceNum">
                <entity-find entity-name="growerp.course.CourseModule" list="existingModules">
                    <econdition field-name="courseId"/>
                </entity-find>
                <set field="sequenceNum" from="(existingModules?.size() ?: 0) + 1"/>
            </if>
            <service-call name="create#growerp.course.CourseModule" in-map="[
                pseudoId: seqContext.seqNum,
                courseId: courseId,
                title: title,
                description: description,
                sequenceNum: sequenceNum,
                estimatedDuration: estimatedDuration,
                createdDate: ec.user.nowTimestamp,
                lastModifiedDate: ec.user.nowTimestamp
            ]" out-map="createContext"/>
            <set field="moduleId" from="createContext.moduleId"/>
            <set field="pseudoId" from="seqContext.seqNum"/>
        </actions>
    </service>

    <service verb="update" noun="CourseModule">
        <in-parameters>
            <parameter name="moduleId" required="true"/>
            <parameter name="title"/>
            <parameter name="description"/>
            <parameter name="sequenceNum" type="Integer"/>
            <parameter name="estimatedDuration" type="Integer"/>
        </in-parameters>
        <out-parameters>
            <parameter name="moduleId"/>
        </out-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" out-map="context"/>
            <entity-find-one entity-name="growerp.course.CourseModule" value-field="moduleEntity">
                <field-map field-name="moduleId"/>
            </entity-find-one>
            <entity-find-one entity-name="growerp.course.Course" value-field="courseEntity">
                <field-map field-name="courseId" from="moduleEntity.courseId"/>
            </entity-find-one>
            <if condition="courseEntity?.ownerPartyId != context.ownerPartyId">
                <message error="true">Module not found or access denied</message>
                <return/>
            </if>
            <service-call name="update#growerp.course.CourseModule" in-map="[
                moduleId: moduleId,
                title: title ?: moduleEntity.title,
                description: description ?: moduleEntity.description,
                sequenceNum: sequenceNum ?: moduleEntity.sequenceNum,
                estimatedDuration: estimatedDuration ?: moduleEntity.estimatedDuration,
                lastModifiedDate: ec.user.nowTimestamp
            ]"/>
        </actions>
    </service>

    <service verb="delete" noun="CourseModule">
        <in-parameters>
            <parameter name="moduleId" required="true"/>
        </in-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" out-map="context"/>
            <entity-find-one entity-name="growerp.course.CourseModule" value-field="moduleEntity">
                <field-map field-name="moduleId"/>
            </entity-find-one>
            <entity-find-one entity-name="growerp.course.Course" value-field="courseEntity">
                <field-map field-name="courseId" from="moduleEntity.courseId"/>
            </entity-find-one>
            <if condition="courseEntity?.ownerPartyId != context.ownerPartyId">
                <message error="true">Module not found or access denied</message>
                <return/>
            </if>
            <!-- Delete related lessons -->
            <entity-delete-by-condition entity-name="growerp.course.CourseLesson">
                <econdition field-name="moduleId"/>
            </entity-delete-by-condition>
            <!-- Delete related media -->
            <entity-delete-by-condition entity-name="growerp.course.CourseMedia">
                <econdition field-name="moduleId"/>
            </entity-delete-by-condition>
            <entity-delete value-field="moduleEntity"/>
        </actions>
    </service>

    <!-- ========================================================= -->
    <!--  Lesson CRUD Services                                     -->
    <!-- ========================================================= -->

    <service verb="create" noun="CourseLesson">
        <in-parameters>
            <parameter name="moduleId" required="true"/>
            <parameter name="title" required="true"/>
            <parameter name="content"/>
            <parameter name="keyPoints"/> <!-- JSON array -->
            <parameter name="sequenceNum" type="Integer"/>
            <parameter name="estimatedDuration" type="Integer"/>
            <parameter name="videoUrl"/>
            <parameter name="imageUrl"/>
        </in-parameters>
        <out-parameters>
            <parameter name="lessonId"/>
            <parameter name="pseudoId"/>
        </out-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" out-map="context"/>
            <entity-find-one entity-name="growerp.course.CourseModule" value-field="moduleEntity">
                <field-map field-name="moduleId"/>
            </entity-find-one>
            <entity-find-one entity-name="growerp.course.Course" value-field="courseEntity">
                <field-map field-name="courseId" from="moduleEntity.courseId"/>
            </entity-find-one>
            <if condition="courseEntity?.ownerPartyId != context.ownerPartyId">
                <message error="true">Module not found or access denied</message>
                <return/>
            </if>
            <service-call name="growerp.100.GeneralServices100.getNext#PseudoId"
                in-map="[ownerPartyId: context.ownerPartyId, seqName: 'CourseLesson']" out-map="seqContext"/>
            <if condition="!sequenceNum">
                <entity-find entity-name="growerp.course.CourseLesson" list="existingLessons">
                    <econdition field-name="moduleId"/>
                </entity-find>
                <set field="sequenceNum" from="(existingLessons?.size() ?: 0) + 1"/>
            </if>
            <service-call name="create#growerp.course.CourseLesson" in-map="[
                pseudoId: seqContext.seqNum,
                moduleId: moduleId,
                courseId: moduleEntity.courseId,
                title: title,
                content: content,
                keyPoints: keyPoints,
                sequenceNum: sequenceNum,
                estimatedDuration: estimatedDuration,
                videoUrl: videoUrl,
                imageUrl: imageUrl,
                createdDate: ec.user.nowTimestamp,
                lastModifiedDate: ec.user.nowTimestamp
            ]" out-map="createContext"/>
            <set field="lessonId" from="createContext.lessonId"/>
            <set field="pseudoId" from="seqContext.seqNum"/>
        </actions>
    </service>

    <service verb="update" noun="CourseLesson">
        <in-parameters>
            <parameter name="lessonId" required="true"/>
            <parameter name="title"/>
            <parameter name="content"/>
            <parameter name="keyPoints"/>
            <parameter name="sequenceNum" type="Integer"/>
            <parameter name="estimatedDuration" type="Integer"/>
            <parameter name="videoUrl"/>
            <parameter name="imageUrl"/>
        </in-parameters>
        <out-parameters>
            <parameter name="lessonId"/>
        </out-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" out-map="context"/>
            <entity-find-one entity-name="growerp.course.CourseLesson" value-field="lessonEntity">
                <field-map field-name="lessonId"/>
            </entity-find-one>
            <entity-find-one entity-name="growerp.course.Course" value-field="courseEntity">
                <field-map field-name="courseId" from="lessonEntity.courseId"/>
            </entity-find-one>
            <if condition="courseEntity?.ownerPartyId != context.ownerPartyId">
                <message error="true">Lesson not found or access denied</message>
                <return/>
            </if>
            <service-call name="update#growerp.course.CourseLesson" in-map="[
                lessonId: lessonId,
                title: title ?: lessonEntity.title,
                content: content ?: lessonEntity.content,
                keyPoints: keyPoints ?: lessonEntity.keyPoints,
                sequenceNum: sequenceNum ?: lessonEntity.sequenceNum,
                estimatedDuration: estimatedDuration ?: lessonEntity.estimatedDuration,
                videoUrl: videoUrl ?: lessonEntity.videoUrl,
                imageUrl: imageUrl ?: lessonEntity.imageUrl,
                lastModifiedDate: ec.user.nowTimestamp
            ]"/>
        </actions>
    </service>

    <service verb="delete" noun="CourseLesson">
        <in-parameters>
            <parameter name="lessonId" required="true"/>
        </in-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" out-map="context"/>
            <entity-find-one entity-name="growerp.course.CourseLesson" value-field="lessonEntity">
                <field-map field-name="lessonId"/>
            </entity-find-one>
            <entity-find-one entity-name="growerp.course.Course" value-field="courseEntity">
                <field-map field-name="courseId" from="lessonEntity.courseId"/>
            </entity-find-one>
            <if condition="courseEntity?.ownerPartyId != context.ownerPartyId">
                <message error="true">Lesson not found or access denied</message>
                <return/>
            </if>
            <!-- Delete related media -->
            <entity-delete-by-condition entity-name="growerp.course.CourseMedia">
                <econdition field-name="lessonId"/>
            </entity-delete-by-condition>
            <entity-delete value-field="lessonEntity"/>
        </actions>
    </service>

    <!-- ========================================================= -->
    <!--  Course Media Services                                    -->
    <!-- ========================================================= -->

    <service verb="list" noun="CourseMedia">
        <in-parameters>
            <parameter name="courseId"/>
            <parameter name="platform"/>
            <parameter name="status"/>
        </in-parameters>
        <out-parameters>
            <parameter name="mediaList" type="List"/>
        </out-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" out-map="context"/>
            <entity-find entity-name="growerp.course.CourseMedia" list="mediaList">
                <econdition field-name="ownerPartyId" from="context.ownerPartyId"/>
                <econdition field-name="courseId" ignore-if-empty="true"/>
                <econdition field-name="platform" ignore-if-empty="true"/>
                <econdition field-name="status" ignore-if-empty="true"/>
                <order-by field-name="createdDate"/>
            </entity-find>
        </actions>
    </service>

    <service verb="update" noun="CourseMedia">
        <in-parameters>
            <parameter name="mediaId" required="true"/>
            <parameter name="title"/>
            <parameter name="editedContent"/>
            <parameter name="status"/>
            <parameter name="scheduledDate" type="Timestamp"/>
        </in-parameters>
        <out-parameters>
            <parameter name="mediaId"/>
        </out-parameters>
        <actions>
            <service-call name="growerp.100.GeneralServices100.get#RelatedCompanyAndOwner" out-map="context"/>
            <entity-find-one entity-name="growerp.course.CourseMedia" value-field="mediaEntity">
                <field-map field-name="mediaId"/>
            </entity-find-one>
            <if condition="mediaEntity?.ownerPartyId != context.ownerPartyId">
                <message error="true">Media not found or access denied</message>
                <return/>
            </if>
            <service-call name="update#growerp.course.CourseMedia" in-map="[
                mediaId: mediaId,
                title: title ?: mediaEntity.title,
                editedContent: editedContent ?: mediaEntity.editedContent,
                status: status ?: mediaEntity.status,
                scheduledDate: scheduledDate ?: mediaEntity.scheduledDate,
                lastModifiedDate: ec.user.nowTimestamp
            ]"/>
        </actions>
    </service>

    <!-- ========================================================= -->
    <!--  Course Progress Services                                 -->
    <!-- ========================================================= -->

    <service verb="get" noun="CourseProgress">
        <in-parameters>
            <parameter name="courseId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="progress" type="Map"/>
        </out-parameters>
        <actions>
            <entity-find-one entity-name="growerp.course.CourseProgress" value-field="progressEntity">
                <field-map field-name="userId" from="ec.user.userId"/>
                <field-map field-name="courseId"/>
            </entity-find-one>
            <if condition="progressEntity">
                <set field="progress" from="progressEntity.getMap()"/>
            <else>
                <set field="progress" from="[courseId: courseId, progressPercent: 0, completedLessons: '[]']"/>
            </else>
            </if>
        </actions>
    </service>

    <service verb="update" noun="CourseProgress">
        <in-parameters>
            <parameter name="courseId" required="true"/>
            <parameter name="lessonId" required="true"/>
            <parameter name="completed" type="Boolean" default="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="progressPercent" type="Integer"/>
        </out-parameters>
        <actions>
            <entity-find-one entity-name="growerp.course.CourseProgress" value-field="progressEntity">
                <field-map field-name="userId" from="ec.user.userId"/>
                <field-map field-name="courseId"/>
            </entity-find-one>
            <!-- Get total lessons for progress calculation -->
            <entity-find entity-name="growerp.course.CourseLesson" list="allLessons">
                <econdition field-name="courseId"/>
            </entity-find>
            <set field="totalLessons" from="allLessons.size()"/>
            
            <if condition="progressEntity">
                <script>
                    import groovy.json.JsonSlurper
                    import groovy.json.JsonOutput
                    def slurper = new JsonSlurper()
                    def completedList = slurper.parseText(progressEntity.completedLessons ?: '[]') as List
                    if (completed &amp;&amp; !completedList.contains(lessonId)) {
                        completedList.add(lessonId)
                    } else if (!completed) {
                        completedList.remove(lessonId)
                    }
                    context.completedLessonsJson = JsonOutput.toJson(completedList)
                    context.progressPercent = totalLessons > 0 ? ((completedList.size() * 100) / totalLessons) as Integer : 0
                    context.isCompleted = completedList.size() == totalLessons
                </script>
                <service-call name="update#growerp.course.CourseProgress" in-map="[
                    progressId: progressEntity.progressId,
                    currentLessonId: lessonId,
                    completedLessons: completedLessonsJson,
                    progressPercent: progressPercent,
                    lastAccessDate: ec.user.nowTimestamp,
                    completedDate: isCompleted ? ec.user.nowTimestamp : null
                ]"/>
            <else>
                <script>
                    import groovy.json.JsonOutput
                    def completedList = completed ? [lessonId] : []
                    context.completedLessonsJson = JsonOutput.toJson(completedList)
                    context.progressPercent = totalLessons > 0 ? ((completedList.size() * 100) / totalLessons) as Integer : 0
                </script>
                <service-call name="create#growerp.course.CourseProgress" in-map="[
                    userId: ec.user.userId,
                    courseId: courseId,
                    currentLessonId: lessonId,
                    completedLessons: completedLessonsJson,
                    progressPercent: progressPercent,
                    startedDate: ec.user.nowTimestamp,
                    lastAccessDate: ec.user.nowTimestamp
                ]"/>
            </else>
            </if>
        </actions>
    </service>

    <!-- ========================================================= -->
    <!--  AI Media Generation Service (delegates to Groovy)       -->
    <!-- ========================================================= -->

    <service verb="generate" noun="CourseMedia">
        <in-parameters>
            <parameter name="courseId" required="true"/>
            <parameter name="platform" required="true"/> <!-- LINKEDIN, MEDIUM, EMAIL, YOUTUBE, TWITTER, SUBSTACK, INAPP -->
            <parameter name="moduleId"/>
            <parameter name="lessonId"/>
        </in-parameters>
        <out-parameters>
            <parameter name="mediaId"/>
            <parameter name="generatedContent"/>
        </out-parameters>
        <actions>
            <script location="component://growerp/service/generateCourseMediaWithAI.groovy"/>
        </actions>
    </service>

</services>
