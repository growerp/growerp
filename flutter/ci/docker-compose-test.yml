services:
  sut:
    build:
      context: ..
      dockerfile: ci/Dockerfile
    image: growerp/flutter-test-runner:latest
    # pull_policy: never
    mem_limit: 6g
    memswap_limit: 6g
    working_dir: /home/mobiledevops/growerp
    user: root
    volumes:
      - ..:/home/mobiledevops/growerp
    environment:
      - PACKAGE_FILTER=${PACKAGE_FILTER:-}
      - TEST_FILE=${TEST_FILE:-}
      # Disable Gradle daemon to prevent memory accumulation across test runs
      - GRADLE_OPTS=-Dorg.gradle.daemon=false -Xmx2g -Dkotlin.compiler.execution.strategy=in-process
    depends_on:
      emulator:
        condition: service_healthy
    command: bash -c "ci/test/run_tests.sh"

  emulator:
    image: growerp/android-emulator
    container_name: emulator
    restart: unless-stopped
    mem_limit: 4g
    memswap_limit: 4g
    ports:
      - 5556:5556
      - 5557:5557
    depends_on:
      - moqui
    privileged: true
    devices:
      - "/dev/kvm:/dev/kvm"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "adb devices | grep -q 'emulator.*device' && adb shell getprop sys.boot_completed | grep -q 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 120s
    command: bash -c "/entrypoint.sh 5556 5557"

  moqui:
    image: growerp/growerp-moqui:latest
    # build: ../moqui
    container_name: moqui
    restart: always
    mem_limit: 1536m
    memswap_limit: 1536m
    ports:
      - 127.0.0.1:80:80
    depends_on:
      - moqui-database
    volumes:
      #- ./MoquiProductionConf.xml:/opt/moqui/runtime/conf/MoquiProductionConf.xml
      #- ./runtime/lib:/opt/moqui/runtime/lib
      #- ./runtime/classes:/opt/moqui/runtime/classes
      - ../../moqui/runtime/component:/opt/moqui/runtime/component
      #- ./runtime/log:/opt/moqui/runtime/log
      #- ./runtime/txlog:/opt/moqui/runtime/txlog
      #- ../docker/runtime/sessions:/opt/moqui/runtime/sessions
      # this one isn't needed when not using H2/etc: - ./runtime/db:/opt/moqui/runtime/db
      #- ../docker/runtime/csstyles:/opt/moqui/runtime/component/PopRestStore/screen/store/components/styles
    environment:
      - instance_purpose=test
      - entity_ds_db_conf=postgres
      - entity_ds_host=moqui-database
      - entity_ds_port=5432
      - entity_ds_database=moqui
      - entity_ds_schema=public
      - entity_ds_user=moqui
      - entity_ds_password=moqui
      - entity_ds_crypt_pass='MoquiDefaultPassword:CHANGEME'
      # Limit Moqui JVM heap to prevent unbounded memory growth
      - JAVA_TOOL_OPTIONS=-Xmx768m -XX:MaxMetaspaceSize=256m
      # CHANGE ME - note that VIRTUAL_HOST is for nginx-proxy so it picks up this container as one it should reverse proxy
      # this can be a comma separate list of hosts like 'example.com,www.example.com'
      - webapp_allow_origins=*
      # moqui will accept traffic from other hosts but these are the values used for URL writing when specified:
      - webapp_http_host=
      - webapp_http_port=80
      # nginx-proxy populates X-Real-IP with remote_addr by default, better option for outer proxy than X-Forwarded-For which defaults to proxy_add_x_forwarded_for
      - webapp_client_ip_header=X-Real-IP
      - default_locale=en_US
      - default_time_zone=US/Pacific
      - DB_DATA=INSTALL
      # do not use quotes here
      - SMTP_USER=
      - SMTP_PASSWORD=
      - BIRDSEND_API_KEY=
      - BIRDSEND_AUTM_SEQUENCE=

  moqui-database:
    image: postgres:17.2
    container_name: postgres
    restart: always
    mem_limit: 512m
    memswap_limit: 512m
    ports:
      # change this as needed to bind to any address or even comment to not expose port outside containers
      - 127.0.0.1:5432:5432
      #volumes:
      # edit these as needed to map configuration and data storage
      #- ../docker/db/postgres/data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=moqui
      - POSTGRES_DB_SCHEMA=public
      - POSTGRES_USER=moqui
      - POSTGRES_PASSWORD=moqui
    # PGDATA, POSTGRES_INITDB_ARGS
    # Limit PostgreSQL shared memory and work memory for testing
    command: postgres -c shared_buffers=128MB -c work_mem=4MB -c maintenance_work_mem=64MB
